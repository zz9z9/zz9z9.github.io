<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="MSA 환경에서 테스트하기(2) - 통합 테스트" /><meta property="og:locale" content="en_US" /><meta name="description" content="※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 10장을 읽고 필요한 부분을 정리한 내용입니다." /><meta property="og:description" content="※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 10장을 읽고 필요한 부분을 정리한 내용입니다." /><link rel="canonical" href="https://zz9z9.github.io/posts/msa-testing-part2/" /><meta property="og:url" content="https://zz9z9.github.io/posts/msa-testing-part2/" /><meta property="og:site_name" content="zz9z9" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-11T22:25:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MSA 환경에서 테스트하기(2) - 통합 테스트" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-11-09T14:44:11+09:00","datePublished":"2021-07-11T22:25:00+09:00","description":"※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 10장을 읽고 필요한 부분을 정리한 내용입니다.","headline":"MSA 환경에서 테스트하기(2) - 통합 테스트","mainEntityOfPage":{"@type":"WebPage","@id":"https://zz9z9.github.io/posts/msa-testing-part2/"},"url":"https://zz9z9.github.io/posts/msa-testing-part2/"}</script><title>MSA 환경에서 테스트하기(2) - 통합 테스트 | zz9z9</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zz9z9"><meta name="application-name" content="zz9z9"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-Q7PWLG5WYT"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Q7PWLG5WYT'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Soccerball.svg/1000px-Soccerball.svg.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zz9z9</a></div><div class="site-subtitle font-italic">거창한 계획보다는, 꾸준한 실행을</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zz9z9" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>MSA 환경에서 테스트하기(2) - 통합 테스트</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>MSA 환경에서 테스트하기(2) - 통합 테스트</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Lee JaeYoon </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sun, Jul 11, 2021, 10:25 PM +0900" prep="on" > Jul 11, 2021 <i class="unloaded">2021-07-11T22:25:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Nov 9, 2024, 2:44 PM +0900" prefix="Updated " > Nov 9, 2024 <i class="unloaded">2024-11-09T14:44:11+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="3146 words">17 min</span></div></div><div class="post-content"><p><em>※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 10장을 읽고 필요한 부분을 정리한 내용입니다.</em></p><blockquote><p><strong><em>서비스가 서로 올바르게 상호 작용하는지에 대해서는 단위 테스트만으로는 확인할 수 없다. 예를 들어, 실제 DB에 저장을 했는지, 커맨드 메세지를 올바른 포맷으로, 올바른 채널에 전송했는지 등에 대한 부분이다. 이를 위해, 서비스를 전부 띄워 놓고 일일이 API를 호출해 보는 종단 간 테스트를 해보면 가장 확실하겠지만 이런 테스트는 느리고 취약하며 비용이 많이 든다. 따라서, 다른 서비스와 제대로 상호 작용하는지 확인하기 위해서는 단위 테스트 바로 윗 단계인 ‘통합 테스트’가 필요하다.</em></strong></p></blockquote><h1 id="컨슈머-주도-계약-테스트consumer-driven-contract-test">컨슈머 주도 계약 테스트(consumer-driven contract test)</h1><hr /><blockquote><p>통합 테스트를 진행하기에 앞서 ‘계약’이라는 개념에 대해 알고가자. 두 서비스 간의 상호 작용은 두 서비스 사이의 합의 또는 계약이다. 예를 들어, 주문 서비스와 주문 이력 서비스는 서로에게 발행될 이벤트 메세지의 구조와 채널에 대해 합의해야 한다. API 게이트웨이와 도메인 서비스 역시 REST API 끝점에 대해 합의해야 한다.</p></blockquote><ul><li>서비스가 클라이언트의 기대에 부합하는지 확인하는 테스트<ul><li>클라이언트는 어떠한 서비스를 호출하는 서비스(API 게이트웨이, 다른 도메인 서비스 등)이다.</ul><li>컨슈머(호출하는 서비스)-프로바이더(호출되는 서비스)의 관계를 맺는다.<li>프로바이더의 API가 컨슈머가 기대한 바와 일치하는지 확인하는 것. 즉, 프로바이더에 대한 통합 테스트이다.<li>비즈니스 로직을 체크하는 테스트가 아니다.<li>다음 사항을 확인<ul><li>컨슈머가 기대한 HTTP 메서드와 경로인가 ?<li>(헤더가 있는 경우) 컨슈머가 기대한 헤더를 받는가 ?<li>(요청 본문이 있는 경우) 요청 본문을 받는가 ?<li>컨슈머가 기대한 상태 코드, 헤더, 본문이 포함된 응답을 반환하는가 ?</ul><li>컨슈머/프로바이더간 상호 작용을 계약(contract)이라는 샘플 모음집으로 정의하는 것<ul><li>예를 들어, REST API의 계약은 HTTP 요청/응답 샘플을 모아 놓은 것</ul><li><code class="language-plaintext highlighter-rouge">Spring Cloud Contract</code>를 사용하여 컨슈머 계약 테스트를 진행할 수 있다.<li>프로세스<ol><li>컨슈머 팀은 개발한 서비스가 프로바이더와 상호 작용하는 방법이 기술된 계약을 작성해서 깃 풀 리퀘스트 등을 통해 프로바이더 팀에 전달<li>프로바이더 팀은 계약을 JAR로 패키징해서 메이븐 저장소에 발행<li>컨슈머 쪽 테스트는 저장소에서 JAR 파일을 내려받는다.<li>주문 서비스의 API를 소비하는 컨슈머 개발 팀은 계약 테스트 스위트를 추가하고, 기대대로 주문 서비스 API가 동작하는지 확인</ol></ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125169689-4fa6ef00-e1e6-11eb-9f4a-4ed0991e6054.png" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.302</figcaption></figure><h1 id="통합-테스트-작성">통합 테스트 작성</h1><hr /><h2 id="통합-테스트-전략">통합 테스트 전략</h2><blockquote><p>통합 테스트는 전체 서비스를 실행시키지 않는다. 테스트 효과에 영향을 끼치지 않으면서 테스트를 간소화하기 위해 두 가지 전략을 사용한다.</p></blockquote><ol><li>각 서비스의 어댑터(가능하면 어댑터의 지원 클래스까지)를 테스트<ul><li>예를 들어, JPA 영속화 테스트를 위해서는 API를 호출하는게 아니라 OrderRepository 클래스를 직접 테스트<li>전체 서비스 대신 소수의 클래스로 테스트 범위를 좁히면 테스트가 단순/신속해진다.</ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125203628-294f8500-e2b4-11eb-9a45-f9f942ce4280.png" width="80%" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.319</figcaption></figure><li>계약(두 서비스 간 상호 작용의 구체적인 사례)을 활용<ul><li>계약의 구조는 서비스 간 상호 작용의 종류마다 다르다.<li>소비자 측 테스트<ul><li>컨슈머 어댑터에 대한 테스트로서 계약을 이용하여 프로바이더를 모킹한 스텁을 구성<li>프로바이더를 실행할 필요 없이 컨슈머 통합 테스트를 작성할 수 있다.</ul><li>프로바이더 측 테스트<ul><li>프로바이더의 어댑터에 대한 테스트로서 어댑터의 디펜던시를 목으로 잡아 놓고 계약을 이용하여 어댑터를 테스트</ul></ul></ol><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125203537-b47c4b00-e2b3-11eb-9b09-2090f043c734.png" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.320</figcaption></figure><h2 id="영속화-테스트">영속화 테스트</h2><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125310840-e6ea7e80-e36d-11eb-83d6-bd43be9b5bb7.png" width="70%" /><figcaption align="center">영속화 테스트 영역</figcaption></figure><ul><li>서비스의 DB 접근 로직이 잘 동작하는지 확인해야한다. 일반적으로 다음과 같은 절차를 거친다.<ol><li>설정 - DB 스키마 생성 및 DB 트랜잭션 시작<li>실행 - DB 작업 수행<li>확인 - DB 상태, 조회한 객체 assertion<li>정리 - 트랜잭션 롤백 등 DB에 변경한 내용 undo</ol></ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="nc">OrderJpaTestConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderJpaTest</span> <span class="o">{</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">OrderRepository</span> <span class="n">orderRepository</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">TransactionTemplate</span> <span class="n">transactionTemplate</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldSaveAndLoadOrder</span><span class="o">()</span> <span class="o">{</span>

    <span class="kt">long</span> <span class="n">orderId</span> <span class="o">=</span> <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">((</span><span class="n">ts</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">Order</span><span class="o">(</span><span class="no">CONSUMER_ID</span><span class="o">,</span> <span class="no">AJANTA_ID</span><span class="o">,</span> <span class="n">chickenVindalooLineItems</span><span class="o">());</span>
      <span class="n">orderRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">order</span><span class="o">.</span><span class="na">getId</span><span class="o">();</span>
    <span class="o">});</span>


    <span class="n">transactionTemplate</span><span class="o">.</span><span class="na">execute</span><span class="o">((</span><span class="n">ts</span><span class="o">)</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="n">orderId</span><span class="o">).</span><span class="na">get</span><span class="o">();</span>

      <span class="n">assertNotNull</span><span class="o">(</span><span class="n">order</span><span class="o">);</span>
      <span class="n">assertEquals</span><span class="o">(</span><span class="nc">OrderState</span><span class="o">.</span><span class="na">APPROVAL_PENDING</span><span class="o">,</span> <span class="n">order</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
      <span class="n">assertEquals</span><span class="o">(</span><span class="no">AJANTA_ID</span><span class="o">,</span> <span class="n">order</span><span class="o">.</span><span class="na">getRestaurantId</span><span class="o">());</span>
      <span class="n">assertEquals</span><span class="o">(</span><span class="no">CONSUMER_ID</span><span class="o">,</span> <span class="n">order</span><span class="o">.</span><span class="na">getConsumerId</span><span class="o">().</span><span class="na">longValue</span><span class="o">());</span>
      <span class="n">assertEquals</span><span class="o">(</span><span class="n">chickenVindalooLineItems</span><span class="o">(),</span> <span class="n">order</span><span class="o">.</span><span class="na">getLineItems</span><span class="o">());</span>
      <span class="k">return</span> <span class="kc">null</span><span class="o">;</span>
    <span class="o">});</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="nd">@EnableJpaRepositories</span>
<span class="nd">@EnableAutoConfiguration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderJpaTestConfiguration</span> <span class="o">{</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>테스트에서 사용된 DB를 어떻게 프로비저닝(시스템을 즉시 사용할 수 있는 상태로 준비해 두는 것) 하느냐가 중요하다<ul><li>테스트 도중에 DB 인스턴스를 실행하는 효과적인 방법은 <code class="language-plaintext highlighter-rouge">도커</code>를 활용하는 것이다.<li>이러한 방법을 통해 영속화 통합 테스트를 하는 동안에 MySQL 같은 DB를 실행할 수 있다.</ul></ul><h2 id="rest-요청응답형-상호-작용-테스트">REST 요청/응답형 상호 작용 테스트</h2><blockquote><p>REST 클라이언트/서비스는 REST 끝점 및 요청/응답 본문의 구조에 대해 합의해야 한다. 즉, 클라이언트는 정확한 끝점에 HTTP 요청을 보내야하고 서비스는 기대한 응답을 반환해야 한다.</p></blockquote><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125310035-32e8f380-e36d-11eb-8877-3bbe2ee9da8b.png" width="70%" /><figcaption align="center">REST 요청/응답 테스트 영역</figcaption></figure><ul><li>테스트 구성도</ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125314112-dee00e00-e370-11eb-975f-46618e3abdef.png" width="80%" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.323</figcaption></figure><ul><li>컨슈머 측 테스트 : OrderServiceProxy가 주문 서비스를 올바르게 호출했는지<ul><li>OrderServiceProxy ⟷ HTTP 스텁 서버(호출될 도메인 서비스의 동작을 흉내)<li><code class="language-plaintext highlighter-rouge">WireMock</code>은 HTTP 서버를 효과적으로 모킹하는 툴로서, HTTP 스텁 서버를 구현할 수 있다.<li><code class="language-plaintext highlighter-rouge">WireMock</code>을 관리하고 계약에 명시된 HTTP 요청에 응답하도록 구성하는 작업은 <code class="language-plaintext highlighter-rouge">Spring Cloud Contract</code>의 몫이다.</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span><span class="o">=</span><span class="nc">TestConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">webEnvironment</span><span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>
<span class="nd">@AutoConfigureStubRunner</span><span class="o">(</span><span class="n">ids</span> <span class="o">=</span>
        <span class="o">{</span><span class="s">"net.chrisrichardson.ftgo:ftgo-order-service-contracts"</span><span class="o">}</span>
<span class="o">)</span>
<span class="nd">@DirtiesContext</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderServiceProxyIntegrationTest</span> <span class="o">{</span>

  <span class="nd">@Value</span><span class="o">(</span><span class="s">"${stubrunner.runningstubs.ftgo-order-service-contracts.port}"</span><span class="o">)</span>
  <span class="kd">private</span> <span class="kt">int</span> <span class="n">port</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">OrderDestinations</span> <span class="n">orderDestinations</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">OrderServiceProxy</span> <span class="n">orderService</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">orderDestinations</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderDestinations</span><span class="o">();</span>
    <span class="nc">String</span> <span class="n">orderServiceUrl</span> <span class="o">=</span> <span class="s">"http://localhost:"</span> <span class="o">+</span> <span class="n">port</span><span class="o">;</span>
    <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="s">"orderServiceUrl="</span> <span class="o">+</span> <span class="n">orderServiceUrl</span><span class="o">);</span>
    <span class="n">orderDestinations</span><span class="o">.</span><span class="na">setOrderServiceUrl</span><span class="o">(</span><span class="n">orderServiceUrl</span><span class="o">);</span>
    <span class="n">orderService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderServiceProxy</span><span class="o">(</span><span class="n">orderDestinations</span><span class="o">,</span> <span class="nc">WebClient</span><span class="o">.</span><span class="na">create</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldVerifyExistingCustomer</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">OrderInfo</span> <span class="n">result</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">findOrderById</span><span class="o">(</span><span class="s">"99"</span><span class="o">).</span><span class="na">block</span><span class="o">();</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">"99"</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">getOrderId</span><span class="o">());</span>
    <span class="n">assertEquals</span><span class="o">(</span><span class="s">"APPROVAL_PENDING"</span><span class="o">,</span> <span class="n">result</span><span class="o">.</span><span class="na">getState</span><span class="o">());</span>
  <span class="o">}</span>

  <span class="nd">@Test</span><span class="o">(</span><span class="n">expected</span> <span class="o">=</span> <span class="nc">OrderNotFoundException</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldFailToFindMissingOrder</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">orderService</span><span class="o">.</span><span class="na">findOrderById</span><span class="o">(</span><span class="s">"555"</span><span class="o">).</span><span class="na">block</span><span class="o">();</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="nd">@Configuration</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>

<span class="o">}</span>
</pre></table></code></div></div><li>프로바이더 측 테스트 : REST API 끝점이 OrderController에 제대로 구현되었는지<ul><li>MockMvc/Rest Assured Mock Mvc ⟷ OrderController<li><code class="language-plaintext highlighter-rouge">Spring Cloud Contract</code>는 계약을 이용하여 주문 서비스 통합 테스트 코드를 생성</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">BaseHttp</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">StandaloneMockMvcBuilder</span> <span class="nf">controllers</span><span class="o">(</span><span class="nc">Object</span><span class="o">...</span> <span class="n">controllers</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">CommonJsonMapperInitializer</span><span class="o">.</span><span class="na">registerMoneyModule</span><span class="o">();</span>
    <span class="nc">MappingJackson2HttpMessageConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MappingJackson2HttpMessageConverter</span><span class="o">(</span><span class="nc">JSonMapper</span><span class="o">.</span><span class="na">objectMapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">MockMvcBuilders</span><span class="o">.</span><span class="na">standaloneSetup</span><span class="o">(</span><span class="n">controllers</span><span class="o">).</span><span class="na">setMessageConverters</span><span class="o">(</span><span class="n">converter</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">OrderService</span> <span class="n">orderService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">OrderService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">OrderRepository</span> <span class="n">orderRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">OrderRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="nc">OrderController</span> <span class="n">orderController</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderController</span><span class="o">(</span><span class="n">orderService</span><span class="o">,</span> <span class="n">orderRepository</span><span class="o">);</span>

    <span class="n">when</span><span class="o">(</span><span class="n">orderRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="nc">OrderDetailsMother</span><span class="o">.</span><span class="na">ORDER_ID</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="nc">OrderDetailsMother</span><span class="o">.</span><span class="na">CHICKEN_VINDALOO_ORDER</span><span class="o">));</span>
    <span class="n">when</span><span class="o">(</span><span class="n">orderRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">555L</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="n">empty</span><span class="o">());</span>
    <span class="nc">RestAssuredMockMvc</span><span class="o">.</span><span class="na">standaloneSetup</span><span class="o">(</span><span class="n">controllers</span><span class="o">(</span><span class="n">orderController</span><span class="o">));</span>

  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderControllerTest</span> <span class="kd">extends</span> <span class="nc">BaseHttp</span> <span class="o">{</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
    <span class="c1">// do something</span>
  <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div></ul><h2 id="발행구독-상호-작용-테스트">발행/구독 상호 작용 테스트</h2><blockquote><p>발행기/컨슈머가 바라보는 메세지 채널 및 도메인 이벤트 구조가 서로 일치하는지 확인해야한다.</p></blockquote><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125317861-49df1400-e374-11eb-85a2-3e1687877a25.png" width="70%" /><figcaption align="center">발행/구독 테스트 영역</figcaption></figure><ul><li>테스트 구성도</ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125318235-a2aeac80-e374-11eb-80fc-1bd49a7b1bc4.png" width="80%" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.327</figcaption></figure><ul><li>프로바이더 측 테스트 : OrderDomainEventPublisher가 계약대로 이벤트를 발행하는지 확인</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="nc">MessagingBase</span><span class="o">.</span><span class="na">TestConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>
<span class="nd">@AutoConfigureMessageVerifier</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">MessagingBase</span> <span class="o">{</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@EnableAutoConfiguration</span>
  <span class="nd">@Import</span><span class="o">({</span><span class="nc">EventuateContractVerifierConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">TramEventsPublisherConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">TramInMemoryConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">OrderDomainEventPublisher</span> <span class="nf">orderAggregateEventPublisher</span><span class="o">(</span><span class="nc">DomainEventPublisher</span> <span class="n">eventPublisher</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">OrderDomainEventPublisher</span><span class="o">(</span><span class="n">eventPublisher</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>


  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">OrderDomainEventPublisher</span> <span class="n">orderAggregateEventPublisher</span><span class="o">;</span>

  <span class="kd">protected</span> <span class="kt">void</span> <span class="nf">orderCreated</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">orderAggregateEventPublisher</span><span class="o">.</span><span class="na">publish</span><span class="o">(</span><span class="no">CHICKEN_VINDALOO_ORDER</span><span class="o">,</span>
            <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="nc">OrderCreatedEvent</span><span class="o">(</span><span class="no">CHICKEN_VINDALOO_ORDER_DETAILS</span><span class="o">,</span> <span class="no">AJANTA_RESTAURANT_NAME</span><span class="o">)));</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre><span class="kd">class</span> <span class="nc">MessageTest</span> <span class="kd">extends</span> <span class="nc">MessagingBase</span> <span class="o">{</span>

    <span class="nd">@Test</span>
    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">validate_orderCreatedEvent</span><span class="o">()</span> <span class="o">{</span>
        <span class="c1">// 메세지가 기대한 채널로 발행되었는지 확인</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>컨슈머 측 테스트 : OrderHistoryEventHandlers가 계약대로 이벤트를 소비하는지 확인<ul><li>각 테스트 메서드는 스플링 클라우드를 호출해서 계약에 명시된 이벤트 발행<li>OrderHistoryEventHandlers가 OrderHistoryDao를 올바르게 호출하는지 확인</ul></ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="nc">OrderHistoryEventHandlersTest</span><span class="o">.</span><span class="na">TestConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>
<span class="nd">@AutoConfigureStubRunner</span><span class="o">(</span><span class="n">ids</span> <span class="o">=</span>
        <span class="o">{</span><span class="s">"net.chrisrichardson.ftgo:ftgo-order-service-contracts"</span><span class="o">}</span>
        <span class="o">)</span>
<span class="nd">@DirtiesContext</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderHistoryEventHandlersTest</span> <span class="o">{</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@EnableAutoConfiguration</span>
  <span class="nd">@Import</span><span class="o">({</span><span class="nc">OrderHistoryServiceMessagingConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">TramCommandProducerConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">TramInMemoryConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">EventuateContractVerifierConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">ChannelMapping</span> <span class="nf">channelMapping</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nc">DefaultChannelMapping</span><span class="o">.</span><span class="na">DefaultChannelMappingBuilder</span><span class="o">().</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">OrderHistoryDao</span> <span class="nf">orderHistoryDao</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">mock</span><span class="o">(</span><span class="nc">OrderHistoryDao</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">StubFinder</span> <span class="n">stubFinder</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">OrderHistoryDao</span> <span class="n">orderHistoryDao</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldHandleOrderCreatedEvent</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">InterruptedException</span> <span class="o">{</span>
    <span class="n">when</span><span class="o">(</span><span class="n">orderHistoryDao</span><span class="o">.</span><span class="na">addOrder</span><span class="o">(</span><span class="n">any</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">),</span> <span class="n">any</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">class</span><span class="o">))).</span><span class="na">thenReturn</span><span class="o">(</span><span class="kc">false</span><span class="o">);</span>

    <span class="n">stubFinder</span><span class="o">.</span><span class="na">trigger</span><span class="o">(</span><span class="s">"orderCreatedEvent"</span><span class="o">);</span> <span class="c1">// orderCreatedEvent 스텁을 트리거하여 OrderCreated 이벤트 발생</span>

    <span class="n">eventually</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span> <span class="c1">// OrderHistoryEventHandlers가 orderHistoryDao.addOrder() 호출했는지 확인</span>
      <span class="nc">ArgumentCaptor</span><span class="o">&lt;</span><span class="nc">Order</span><span class="o">&gt;</span> <span class="n">orderArg</span> <span class="o">=</span> <span class="nc">ArgumentCaptor</span><span class="o">.</span><span class="na">forClass</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="nc">ArgumentCaptor</span><span class="o">&lt;</span><span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">SourceEvent</span><span class="o">&gt;&gt;</span> <span class="n">sourceEventArg</span> <span class="o">=</span> <span class="nc">ArgumentCaptor</span><span class="o">.</span><span class="na">forClass</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
      <span class="n">verify</span><span class="o">(</span><span class="n">orderHistoryDao</span><span class="o">).</span><span class="na">addOrder</span><span class="o">(</span><span class="n">orderArg</span><span class="o">.</span><span class="na">capture</span><span class="o">(),</span> <span class="n">sourceEventArg</span><span class="o">.</span><span class="na">capture</span><span class="o">());</span>

      <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderArg</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>
      <span class="nc">Optional</span><span class="o">&lt;</span><span class="nc">SourceEvent</span><span class="o">&gt;</span> <span class="n">sourceEvent</span> <span class="o">=</span> <span class="n">sourceEventArg</span><span class="o">.</span><span class="na">getValue</span><span class="o">();</span>

      <span class="n">assertEquals</span><span class="o">(</span><span class="s">"Ajanta"</span><span class="o">,</span> <span class="n">order</span><span class="o">.</span><span class="na">getRestaurantName</span><span class="o">());</span>
    <span class="o">});</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h2 id="비동기-요청응답-상호-작용-테스트">비동기 요청/응답 상호 작용 테스트</h2><blockquote><p>예를 들어, 주문 서비스는 주방 서비스 등 여러 서비스에 커맨드 메세지를 전송하고 수신한 응답 메세지를 사가로 처리한다. 따라서, 커맨드를 전송하는 서비스인 ‘요청자’와 커맨드 처리 후 응답을 반환하는 서비스인 ‘응답자’가 바라보는 커맨드 메세지 채널명과 커맨드/응답 메세지의 구조는 반드시 일치해야 한다.</p></blockquote><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125322455-c542c480-e378-11eb-8222-6e6f339d4b85.png" width="70%" /><figcaption align="center">비동기 요청/응답 테스트 영역</figcaption></figure><ul><li>테스트 구성도</ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125323131-6a5d9d00-e379-11eb-8f1a-e728a0ea3ea1.png" width="80%" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.331</figcaption></figure><ul><li>컨슈머 측(주문 서비스) 테스트 : KitchenServiceProxy가 커맨드 메세지를 전송하고 응답 메세지를 제대로 처리하는지 확인</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span><span class="o">=</span> <span class="nc">KitchenServiceProxyIntegrationTest</span><span class="o">.</span><span class="na">TestConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
        <span class="n">webEnvironment</span><span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>
<span class="nd">@AutoConfigureStubRunner</span><span class="o">(</span><span class="n">ids</span> <span class="o">=</span> <span class="c1">// 주방 서비스 스텁이 메세지에 응답하도록 구성</span>
        <span class="o">{</span><span class="s">"net.chrisrichardson.ftgo:ftgo-kitchen-service-contracts"</span><span class="o">}</span>
        <span class="o">)</span>
<span class="nd">@DirtiesContext</span>
<span class="kd">public</span> <span class="kd">class</span> <span class="nc">KitchenServiceProxyIntegrationTest</span> <span class="o">{</span>


  <span class="nd">@Configuration</span>
  <span class="nd">@EnableAutoConfiguration</span>
  <span class="nd">@Import</span><span class="o">({</span><span class="nc">TramCommandProducerConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span>
          <span class="nc">TramInMemoryConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">EventuateContractVerifierConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>

    <span class="c1">// TramSagaInMemoryConfiguration</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">DataSource</span> <span class="nf">dataSource</span><span class="o">()</span> <span class="o">{</span>
      <span class="nc">EmbeddedDatabaseBuilder</span> <span class="n">builder</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">EmbeddedDatabaseBuilder</span><span class="o">();</span>
      <span class="k">return</span> <span class="n">builder</span><span class="o">.</span><span class="na">setType</span><span class="o">(</span><span class="nc">EmbeddedDatabaseType</span><span class="o">.</span><span class="na">H2</span><span class="o">)</span>
              <span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">"eventuate-tram-embedded-schema.sql"</span><span class="o">)</span>
              <span class="o">.</span><span class="na">addScript</span><span class="o">(</span><span class="s">"eventuate-tram-sagas-embedded.sql"</span><span class="o">)</span>
              <span class="o">.</span><span class="na">build</span><span class="o">();</span>
    <span class="o">}</span>


    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">EventuateTramRoutesConfigurer</span> <span class="nf">eventuateTramRoutesConfigurer</span><span class="o">(</span><span class="nc">BatchStubRunner</span> <span class="n">batchStubRunner</span><span class="o">)</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">EventuateTramRoutesConfigurer</span><span class="o">(</span><span class="n">batchStubRunner</span><span class="o">);</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SagaMessagingTestHelper</span> <span class="nf">sagaMessagingTestHelper</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">SagaMessagingTestHelper</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">SagaCommandProducer</span> <span class="nf">sagaCommandProducer</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">SagaCommandProducer</span><span class="o">();</span>
    <span class="o">}</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">KitchenServiceProxy</span> <span class="nf">kitchenServiceProxy</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="k">new</span> <span class="nf">KitchenServiceProxy</span><span class="o">();</span>
    <span class="o">}</span>
  <span class="o">}</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">SagaMessagingTestHelper</span> <span class="n">sagaMessagingTestHelper</span><span class="o">;</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">KitchenServiceProxy</span> <span class="n">kitchenServiceProxy</span><span class="o">;</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldSuccessfullyCreateTicket</span><span class="o">()</span> <span class="o">{</span>
    <span class="nc">CreateTicket</span> <span class="n">command</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CreateTicket</span><span class="o">(</span><span class="no">AJANTA_ID</span><span class="o">,</span> <span class="nc">OrderDetailsMother</span><span class="o">.</span><span class="na">ORDER_ID</span><span class="o">,</span>
            <span class="k">new</span> <span class="nf">TicketDetails</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="nc">TicketLineItem</span><span class="o">(</span><span class="no">CHICKEN_VINDALOO_MENU_ITEM_ID</span><span class="o">,</span> <span class="no">CHICKEN_VINDALOO</span><span class="o">,</span> <span class="no">CHICKEN_VINDALOO_QUANTITY</span><span class="o">))));</span>
    <span class="nc">CreateTicketReply</span> <span class="n">expectedReply</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CreateTicketReply</span><span class="o">(</span><span class="nc">OrderDetailsMother</span><span class="o">.</span><span class="na">ORDER_ID</span><span class="o">);</span>
    <span class="nc">String</span> <span class="n">sagaType</span> <span class="o">=</span> <span class="nc">CreateOrderSaga</span><span class="o">.</span><span class="na">class</span><span class="o">.</span><span class="na">getName</span><span class="o">();</span>

    <span class="nc">CreateTicketReply</span> <span class="n">reply</span> <span class="o">=</span> <span class="n">sagaMessagingTestHelper</span> <span class="c1">// 커맨드 전송 및 응답 대기</span>
            <span class="o">.</span><span class="na">sendAndReceiveCommand</span><span class="o">(</span><span class="n">kitchenServiceProxy</span><span class="o">.</span><span class="na">create</span><span class="o">,</span> <span class="n">command</span><span class="o">,</span> <span class="nc">CreateTicketReply</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">sagaType</span><span class="o">);</span>

    <span class="n">assertEquals</span><span class="o">(</span><span class="n">expectedReply</span><span class="o">,</span> <span class="n">reply</span><span class="o">);</span> <span class="c1">// 응답 확인</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><ul><li>프로바이더 측(주방 서비스) 테스트 : KitchenServiceCommandHandler가 커맨드 처리 후 응답을 반환하는지 확인</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
</pre><td class="rouge-code"><pre><span class="nd">@RunWith</span><span class="o">(</span><span class="nc">SpringRunner</span><span class="o">.</span><span class="na">class</span><span class="o">)</span>
<span class="nd">@SpringBootTest</span><span class="o">(</span><span class="n">classes</span> <span class="o">=</span> <span class="nc">AbstractKitchenServiceConsumerContractTest</span><span class="o">.</span><span class="na">TestConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="n">webEnvironment</span> <span class="o">=</span> <span class="nc">SpringBootTest</span><span class="o">.</span><span class="na">WebEnvironment</span><span class="o">.</span><span class="na">NONE</span><span class="o">)</span>
<span class="nd">@AutoConfigureMessageVerifier</span>
<span class="kd">public</span> <span class="kd">abstract</span> <span class="kd">class</span> <span class="nc">AbstractKitchenServiceConsumerContractTest</span> <span class="o">{</span>

  <span class="nd">@Configuration</span>
  <span class="nd">@Import</span><span class="o">({</span><span class="nc">KitchenServiceMessageHandlersConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="nc">EventuateContractVerifierConfiguration</span><span class="o">.</span><span class="na">class</span><span class="o">})</span>
  <span class="kd">public</span> <span class="kd">static</span> <span class="kd">class</span> <span class="nc">TestConfiguration</span> <span class="o">{</span>

    <span class="nd">@Bean</span>
    <span class="kd">public</span> <span class="nc">KitchenService</span> <span class="nf">kitchenService</span><span class="o">()</span> <span class="o">{</span>
      <span class="k">return</span> <span class="nf">mock</span><span class="o">(</span><span class="nc">KitchenService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="o">}</span>

  <span class="o">}</span>

  <span class="nd">@Autowired</span>
  <span class="kd">private</span> <span class="nc">KitchenService</span> <span class="n">kitchenService</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
     <span class="n">reset</span><span class="o">(</span><span class="n">kitchenService</span><span class="o">);</span>
     <span class="n">when</span><span class="o">(</span><span class="n">kitchenService</span><span class="o">.</span><span class="na">createTicket</span><span class="o">(</span><span class="n">eq</span><span class="o">(</span><span class="mi">1L</span><span class="o">),</span> <span class="n">eq</span><span class="o">(</span><span class="mi">99L</span><span class="o">),</span> <span class="n">any</span><span class="o">(</span><span class="nc">TicketDetails</span><span class="o">.</span><span class="na">class</span><span class="o">)))</span>
             <span class="o">.</span><span class="na">thenReturn</span><span class="o">(</span><span class="k">new</span> <span class="nc">Ticket</span><span class="o">(</span><span class="mi">1L</span><span class="o">,</span> <span class="mi">99L</span><span class="o">,</span> <span class="k">new</span> <span class="nc">TicketDetails</span><span class="o">(</span><span class="nc">Collections</span><span class="o">.</span><span class="na">emptyList</span><span class="o">())));</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h1 id="참고자료">참고자료</h1><hr /><ul><li>크리스 리처드슨, 『마이크로서비스 패턴』, 길벗(2020), 10장</ul></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MSA 환경에서 테스트하기(2) - 통합 테스트 - zz9z9&url=https://zz9z9.github.io/posts/msa-testing-part2/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MSA 환경에서 테스트하기(2) - 통합 테스트 - zz9z9&u=https://zz9z9.github.io/posts/msa-testing-part2/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=MSA 환경에서 테스트하기(2) - 통합 테스트 - zz9z9&url=https://zz9z9.github.io/posts/msa-testing-part2/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/jpa-entity-manager-persistence-context/">EntityManager와 영속성 컨텍스트</a><li><a href="/posts/jpa-id-generation-strategy/">JPA/Hibernate ID 생성 전략</a><li><a href="/posts/aws-vpc/">AWS VPC(Virtual Private Cloud) - 기초 개념</a><li><a href="/posts/aws-efs/">AWS EFS(Elastic File System) - 기초 개념</a><li><a href="/posts/aws-intro/">AWS - 상품 살펴보기</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cautions-when-jpa-mybatis-together/"><div class="card-body"> <span class="timeago small" > Feb 10 <i class="unloaded">2026-02-10T22:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JPA / MyBatis 혼용시 주의사항 (in 배치 애플리케이션)</h3><div class="text-muted small"><p> JPA와 MyBatis는 서로의 존재를 모른다. MyBatis는 JDBC를 직접 사용하므로 JPA 영속성 컨텍스트를 우회하여 DB를 변경하고, JPA는 이를 감지할 수 없다. 결과적으로 JPA 1차 캐시에는 변경 전 데이터(stale data)가 남게 되어 데이터 불일치가 발생한다. 문제 상황 예시 1. 같은 엔티티를 JPA로 읽고 ...</p></div></div></a></div><div class="card"> <a href="/posts/how-jpa-item-writer-merge-works/"><div class="card-body"> <span class="timeago small" > Jan 29 <i class="unloaded">2026-01-29T23:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>이슈 - JpaItemWriter로 엔티티 저장시, ChunkSize만큼 SELECT 쿼리 발생하는 상황</h3><div class="text-muted small"><p> 상황 배치 애플리케이션에서 A 테이블에서 조회 -&gt; 가공 -&gt; B 테이블에 저장 흐름으로 동작하는 청크 기반의 Job이 있음 B 테이블에 저장시 JpaItemWriter 사용 B 테이블에 저장하는 엔티티의 PK는 A 테이블의 PK와 동일. 즉, A 테이블에서 조회한 엔티티의 PK가 사용됨 (Assigned ID + @Vers...</p></div></div></a></div><div class="card"> <a href="/posts/jpa-id-generation-strategy/"><div class="card-body"> <span class="timeago small" > Jan 29 <i class="unloaded">2026-01-29T23:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JPA/Hibernate ID 생성 전략</h3><div class="text-muted small"><p> @GeneratedValue 기본 키(primary key) 값의 생성 전략을 지정하는 데 사용 즉, 데이터베이스에 새 레코드를 삽입할 때 기본 키 값을 자동으로 생성하는 방법을 지정 @GeneratedValue는 @Id와 함께 엔티티 또는 매핑된 슈퍼클래스의 기본 키 속성이나 필드에 적용할 수 있다. @GeneratedValu...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/msa-testing-part1/" class="btn btn-outline-primary" prompt="Older"><p>MSA 환경에서 테스트하기(1) - 단위 테스트</p></a> <a href="/posts/applying-unit-test-code-in-company/" class="btn btn-outline-primary" prompt="Newer"><p>MSA 기반의 회사 프로젝트에 단위 테스트 코드 적용하기</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/username">Lee JaeYoon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zz9z9.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
