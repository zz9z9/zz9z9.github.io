<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was … milliseconds ago)" /><meta property="og:locale" content="en_US" /><meta name="description" content="상황 최근 배치 애플리케이션의 커넥션 풀 관련 설정을 변경한 후 MMS 발송하는 job에서 아래와 같은 에러 발생 1 2 3 4 Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 104,983,345 milliseconds ago. The last packet sent successfully to the server was 104,983,347 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;." /><meta property="og:description" content="상황 최근 배치 애플리케이션의 커넥션 풀 관련 설정을 변경한 후 MMS 발송하는 job에서 아래와 같은 에러 발생 1 2 3 4 Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 104,983,345 milliseconds ago. The last packet sent successfully to the server was 104,983,347 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;." /><link rel="canonical" href="https://zz9z9.github.io/posts/wait-timeout-exceed-connection/" /><meta property="og:url" content="https://zz9z9.github.io/posts/wait-timeout-exceed-connection/" /><meta property="og:site_name" content="zz9z9" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2023-05-02T10:25:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was … milliseconds ago)" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2023-05-02T10:25:00+09:00","datePublished":"2023-05-02T10:25:00+09:00","description":"상황 최근 배치 애플리케이션의 커넥션 풀 관련 설정을 변경한 후 MMS 발송하는 job에서 아래와 같은 에러 발생 1 2 3 4 Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException: The last packet successfully received from the server was 104,983,345 milliseconds ago. The last packet sent successfully to the server was 104,983,347 milliseconds ago. is longer than the server configured value of &#39;wait_timeout&#39;.","headline":"wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was … milliseconds ago)","mainEntityOfPage":{"@type":"WebPage","@id":"https://zz9z9.github.io/posts/wait-timeout-exceed-connection/"},"url":"https://zz9z9.github.io/posts/wait-timeout-exceed-connection/"}</script><title>wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was ... milliseconds ago) | zz9z9</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zz9z9"><meta name="application-name" content="zz9z9"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-Q7PWLG5WYT"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Q7PWLG5WYT'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Soccerball.svg/1000px-Soccerball.svg.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zz9z9</a></div><div class="site-subtitle font-italic">거창한 계획보다는, 꾸준한 실행을</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zz9z9" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was ... milliseconds ago)</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was ... milliseconds ago)</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Lee JaeYoon </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Tue, May 2, 2023, 10:25 AM +0900" prep="on" > May 2, 2023 <i class="unloaded">2023-05-02T10:25:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1943 words">10 min</span></div></div><div class="post-content"><h2 id="상황">상황</h2><ul><li>최근 배치 애플리케이션의 커넥션 풀 관련 설정을 변경한 후 MMS 발송하는 job에서 아래와 같은 에러 발생<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre>Cause: com.mysql.jdbc.exceptions.jdbc4.CommunicationsException:
The last packet successfully received from the server was 104,983,345 milliseconds ago.
The last packet sent successfully to the server was 104,983,347 milliseconds ago.
is longer than the server configured value of 'wait_timeout'.
</pre></table></code></div></div></ul><h2 id="커넥션-풀-관련-설정">커넥션 풀 관련 설정</h2><ul><li>변경 전<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>initial-size: 0 // 커넥션 풀 최초 사이즈
max-active: 8   // 최대로 활성화할 커넥션 갯수
max-idle: 8     // 커넥션 풀에 유지할 최대 커넥션 갯수
min-idle: 0     // 커넥션 풀에 유지할 최소 커넥션 갯수
max-wait : 3초  // DB 커넥션 얻기위해 대기하는 최대 시간
</pre></table></code></div></div><li>변경 후<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>initial-size: 20 // 커넥션 풀 최초 사이즈
max-active: 20   // 최대로 활성화할 커넥션 갯수
max-idle: 20    // 커넥션 풀에 유지할 최대 커넥션 갯수
min-idle: 20     // 커넥션 풀에 유지할 최소 커넥션 갯수
max-wait : 5초  // DB 커넥션 얻기위해 대기하는 최대 시간
</pre></table></code></div></div></ul><h2 id="에러-원인-찾기">에러 원인 찾기</h2><ul><li>출처 : <a href="https://kakaocommerce.tistory.com/45">https://kakaocommerce.tistory.com/45</a><div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre>MySQL 서버 입장에서 JDBC 커넥션이 Idle인 상태로 wait_timeout(default 28800초) 이상 사용되지 않을 경우
해당 커넥션을 close 하여 할당된 리소스를 회수하게 된다.
이런 경우 TCP 레벨에서 해당 socket이 정리가 되더라도 JDBC 드라이버나 커넥션 풀에서는 close 여부를 바로 알 수 없고
해당 커넥션을 사용하려고 시도 할 때에서야 비로소 커넥션에 문제가 있는 것을 알게 된다.
이런 상황일 경우 최근에 성공한 통신이 XXX,XXX milliseonds 이전이라고 위와 같은 에러 메시지를 출력하게 된다.
</pre></table></code></div></div></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/2937d57c-88a2-412f-9c9b-b20a01a572e0" alt="KakaoTalk_Photo_2023-08-24-23-17-31 001" /></p><p><strong>※ 참고</strong></p><ul><li>CUBRID는 자체적으로 커넥션을 관리하고 자동으로 다시 연결하도록 구현되어있다고 한다. (출처 : <a href="https://d2.naver.com/helloworld/5102792">https://d2.naver.com/helloworld/5102792</a>)</ul><h2 id="에러-재현해보기">에러 재현해보기</h2><ul><li>검증해보고 싶은 부분<ul><li>idle 상태인 커넥션중 <code class="language-plaintext highlighter-rouge">wait_timeout</code> 지나면 mysql 서버에서 해당 커넥션 만큼의 세션(스레드) 갯수가 감소한 것을 확인할 수 있다.<li>닫힌 세션에 맵핑된 커넥션으로 질의 요청하는 경우 위 에러가 발생한다.</ul><li><p>검증 코드 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/52d4bdb0-3e90-45fe-bcbf-da0650a37f29" alt="KakaoTalk_Photo_2023-08-24-23-17-31 002" /></p><li>검증 과정<ul><li>코드 실행 전 mysql workbench에서 확인한 현재 열려있는 커넥션 갯수 (<code class="language-plaintext highlighter-rouge">show status where variable_name = 'Threads_connected';</code>)<ul><li><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/1f240e48-9337-4591-bf75-8ca3c5d82347" alt="KakaoTalk_Photo_2023-08-24-23-17-31 003" /></ul><li>커넥션 연결 (두 개의 커넥션 중 하나의 커넥션에만 wait_timeout 5초 설정 : ①, 나머지 하나는 default 값인 28800초)<ul><li><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/0bb4e418-3b84-4d5f-b2da-0df65e0fda18" alt="KakaoTalk_Photo_2023-08-24-23-17-31 004" /></ul><li><code class="language-plaintext highlighter-rouge">wait_timeout</code> 이상 대기 (②)<ul><li><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/72d4019d-0f25-4142-8374-dbfda759341e" alt="KakaoTalk_Photo_2023-08-24-23-17-31 005" /><li><strong>“idle 상태인 커넥션중 <code class="language-plaintext highlighter-rouge">wait_timeout</code> 지나면 mysql 서버에서 해당 커넥션 만큼의 세션(스레드) 갯수가 감소한 것을 확인할 수 있다.”</strong> 에 대해 검증 완료</ul><li>mysql 서버에서 닫힌 커넥션에 질의할시 동일한 에러 발생(③)<ul><li><strong>“닫힌 세션에 맵핑된 커넥션으로 질의 요청하는 경우 위 에러가 발생한다.”</strong> 에 대해 검증 완료<div class="language-plaintext highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre>Exception in thread "main" com.mysql.cj.jdbc.exceptions.CommunicationsException:
The last packet successfully received from the server was 107,054 milliseconds ago. (중략 ...)
</pre></table></code></div></div></ul></ul></ul><h3 id="의문점">의문점</h3><blockquote><p>MMS 발송 job은 5분마다 돌면서 발송 대상이 있는지 조회한다. 그리고 발송 job 이외에도 주기적으로 도는 다른 job들도 있기 때문에 커넥션 풀에 있는 커넥션들이 주기적으로 사용될 것 같은데 왜 커넥션이 끊어진걸까 ?</p></blockquote><h2 id="커넥션-풀-내부-살펴보기">커넥션 풀 내부 살펴보기</h2><blockquote><p>tomcat-jdbc-7.0.56</p></blockquote><ul><li><code class="language-plaintext highlighter-rouge">org.apache.tomcat.jdbc.pool.ConnectionPool</code> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/09089ac7-c614-4733-bc85-39f3d738780a" alt="KakaoTalk_Photo_2023-08-24-23-32-29" /></ul><h3 id="커넥션-풀-초기화">커넥션 풀 초기화</h3><ul><li><p><code class="language-plaintext highlighter-rouge">BlockingQueue</code> 구현 클래스 할당 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/9c4a350b-cfb0-40b4-897e-9f40b5bdbd91" alt="KakaoTalk_Photo_2023-08-24-23-33-09" /></p><ul><li>idle 커넥션 큐는 <code class="language-plaintext highlighter-rouge">FairBlockingQueue</code>(<a href="https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/tomcat/jdbc/pool/FairBlockingQueue.html">https://tomcat.apache.org/tomcat-7.0-doc/api/org/apache/tomcat/jdbc/pool/FairBlockingQueue.html</a>)</ul><li><p>실제 커넥션 할당 (busy 큐에 들어가게됨) <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/1bf3d3a1-aeb6-465b-89e8-50fcfdeef6df" alt="KakaoTalk_Photo_2023-08-24-23-33-16" /></p><li><p>busy 큐 -&gt; idle 큐로 이동 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/d5af625c-9eb8-4e60-9667-decf58ac630f" alt="KakaoTalk_Photo_2023-08-24-23-35-11" /></p></ul><h3 id="커넥션-가져오기">커넥션 가져오기</h3><ul><li>idle 큐의 맨 앞에 있는 커넥션 가져옴 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/6b24ce08-018e-4dd4-9a62-6bd821462df2" alt="KakaoTalk_Photo_2023-08-24-23-35-18" /></ul><h3 id="커넥션-반납">커넥션 반납</h3><ul><li><p>idle 큐의 <code class="language-plaintext highlighter-rouge">offer</code> 메서드 호출 <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/83279d85-cf05-46ae-a3b7-fc2a0d137dbe" alt="KakaoTalk_Photo_2023-08-24-23-36-38" /></p><li><p>반납된 커넥션이 맨 앞에 들어가는 것을 볼 수 있다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/e7b9a2e7-59f7-4e6c-b759-5097e0ce67b8" alt="KakaoTalk_Photo_2023-08-24-23-36-44" /></p></ul><h2 id="의문점-해결하기">의문점 해결하기</h2><blockquote><p>MMS 발송 job은 5분마다 돌면서 발송 대상이 있는지 조회한다. 그리고 발송 job 이외에도 주기적으로 도는 다른 job들도 있기 때문에 커넥션 풀에 있는 커넥션들이 주기적으로 사용될 것 같은데 왜 커넥션이 끊어진걸까 ?</p></blockquote><ul><li>MMS 발송 로직<ul><li>발송 대상 조회(커넥션1) -&gt; 발송 &amp; 발송 관련 정보 업데이트(비동기 호출, 커넥션2..n)</ul><li>사용되는 커넥션 갯수 추정해보기<ul><li>idle 큐에 보관되는 커넥션 중 MMS 발송 건이 없는 경우엔 맨 앞 커넥션 하나 또는 있더라도 맨 앞부터 n개의 커넥션이 사용될 것 (동시 발송 건수가 많지 않으면 n의 크기가 작을 것.)<li>MMS 발송 job 이외에 커넥션을 여러 개 사용하는 job들은 거의 없고 또한 동시에 job들이 도는 경우도 많지 않기 때문에 n개의 커넥션이 사용된다 하더라도 n의 크기는 작을 것이다.</ul></ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/59b7c5e9-fdc7-407d-b344-ebb374bb87e8" alt="KakaoTalk_Photo_2023-08-24-23-36-51" /></p><ul><li>위에서 살펴보았듯이 커넥션 반납시 큐의 맨 뒤가 아닌 맨 앞에 추가되기 때문에, 사용되는 커넥션만 계속 사용될 것<li><strong>결과적으로, 앞에 몇 개의 커넥션만 계속 사용되다가 MMS 발송건이 여러 건인 경우 8시간(<code class="language-plaintext highlighter-rouge">wait_timeout</code>)이상 사용되지 않았던 뒤쪽의 커넥션(이미 세션이 닫힌)까지 사용하기 때문에 에러가 발생했던 것</strong></ul><h2 id="문제-해결하기">문제 해결하기</h2><h3 id="1-커넥션-풀에-idle-커넥션-갯수-0개로-유지">1. 커넥션 풀에 idle 커넥션 갯수 0개로 유지</h3><ul><li>커넥션 정리는 <code class="language-plaintext highlighter-rouge">ConnectionPool.PoolCleaner</code>에서 담당 (Evictor 스레드)</ul><p><img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://github.com/zz9z9/zz9z9.github.io/assets/64415489/7f763431-c90d-4ef1-a3fd-f97effcc78cf" alt="KakaoTalk_Photo_2023-08-24-23-36-57" /></p><ul><li><strong>사실상 커넥션 풀 사용하는 이점이 사라지는 것(?)</strong><li>트래픽 많지 않아서 현재로서 운영상 이슈는 없음</ul><h3 id="2-poolcleaner에서-주기적으로-커넥션-유효성-체크하도록">2. PoolCleaner에서 주기적으로 커넥션 유효성 체크하도록</h3><ul><li><p><code class="language-plaintext highlighter-rouge">validationQuery</code>, <code class="language-plaintext highlighter-rouge">timeBetweenEvictionRunsMillis</code>, <code class="language-plaintext highlighter-rouge">testWhileIdle</code> 등의 속성 활용하여 주기적으로 커넥션 유효성 검사</p><li><p>유의사항 (출처 : <a href="https://d2.naver.com/helloworld/5102792">https://d2.naver.com/helloworld/5102792</a>) - commons dbcp 1.x 기준</p><ul><li>Evictor 스레드는 동작 시에 커넥션 풀에 잠금(lock)을 걸고 동작하기 때문에 너무 자주 실행하면 서비스 실행에 부담을 줄 수 있다.<li>또한 numTestsPerEvictionRun 값을 크게 설정하면 Evictor 스레드가 검사해야 하는 커넥션 개수가 많아져 잠금 상태에 있는 시간이 길어지므로 역시 서비스 실행에 부담을 줄 수 있다.<li>게다가 커넥션 유효성 검사를 위한 테스트 옵션(testOnBorrow, testOnReturn, testWhileIdle)을 어떻게 설정하느냐에 따라 애플리케이션의 안정성과 DBMS의 부하가 달라질 수 있다. 그러므로 Evictor 스레드와 테스트 옵션을 사용할 때는 데이터베이스 관리자와 상의해서 사용하는 DBMS에 최적화될 수 있는 옵션으로 설정해야 한다.</ul></ul><h3 id="3-autoreconnect-"><del>3. autoReconnect ?</del></h3><ul><li>동작 방식<ul><li>커넥션이 끊어진 경우 예외를 발생시키고 해당 트랜잭션 종료시킴.<li>이후 새로운 트랜잭션에서 해당 커넥션 사용하는 경우 다시 연결 시도.</ul><li><p>따라서, <code class="language-plaintext highlighter-rouge">autoReconnect</code> 속성이 <code class="language-plaintext highlighter-rouge">true</code>이더라도 커넥션이 끊겨서 발생하는 최초의 에러를 막을수는 없다.</p><li><a href="https://dev.mysql.com/doc/connector-j/8.0/en/connector-j-connp-props-high-availability-and-clustering.html#cj-conn-prop_autoReconnect">공식 문서</a> 에서는 데이터 일관성, 세션 상태 등의 이유로 사용하는 것을 추천하지 않는다.</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%EA%B2%BD%ED%97%98%ED%95%98%EA%B8%B0/'>경험하기</a>, <a href='/categories/%EC%9D%B4%EC%8A%88-%EB%85%B8%ED%8A%B8/'>이슈 노트</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/connection-pool/" class="post-tag no-text-decoration" >Connection Pool</a> <a href="/tags/mysql/" class="post-tag no-text-decoration" >MySQL</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was ... milliseconds ago) - zz9z9&url=https://zz9z9.github.io/posts/wait-timeout-exceed-connection/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was ... milliseconds ago) - zz9z9&u=https://zz9z9.github.io/posts/wait-timeout-exceed-connection/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=wait_timeout을 초과한 커넥션을 사용해서 겪은 이슈 (The last packet successfully received from the server was ... milliseconds ago) - zz9z9&url=https://zz9z9.github.io/posts/wait-timeout-exceed-connection/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/jpa-entity-manager-persistence-context/">EntityManager와 영속성 컨텍스트</a><li><a href="/posts/jpa-id-generation-strategy/">JPA/Hibernate ID 생성 전략</a><li><a href="/posts/aws-vpc/">AWS VPC(Virtual Private Cloud) - 기초 개념</a><li><a href="/posts/aws-efs/">AWS EFS(Elastic File System) - 기초 개념</a><li><a href="/posts/aws-intro/">AWS - 상품 살펴보기</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/mysql-round-up-part1/"><div class="card-body"> <span class="timeago small" > Mar 28, 2023 <i class="unloaded">2023-03-28T22:25:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL에서 시간,날짜 데이터를 저장할 때 반올림되는 현상 (1)</h3><div class="text-muted small"><p> 상황 회사에서 판매하는 상품권의 등록만료일시 변경 요청을 받아 작업한 뒤 테스트하던 중 24년 12월 31일 23시 59분 59초로 만료일시를 세팅하려는데 실제 DB에는 25년 1월 1일 0시 0분 0초로 저장되는 현상 발견 기존 코드 import org.apache.commons.lang.time.DateUtils; public void...</p></div></div></a></div><div class="card"> <a href="/posts/mysql-round-up-part2/"><div class="card-body"> <span class="timeago small" > Mar 29, 2023 <i class="unloaded">2023-03-29T22:25:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>MySQL에서 시간,날짜 데이터를 저장할 때 반올림되는 현상 (2)</h3><div class="text-muted small"><p> 상황 이전 포스팅 에서 MySQL 반올림 현상으로 인해 겪었던 이슈를 살펴보았다. 이번 포스팅에서는 해당 이슈를 해결하면서 궁금했던 소수점 초가 제거되기까지의 자료형 변환 과정을 들여다보자. 소수점 초가 제거되기까지의 과정 살펴보기 public void 상품권생성() { 상품권생성정보 info = new 상품권생성정보(param1, ...</p></div></div></a></div><div class="card"> <a href="/posts/mysql-ssl-handshake-fail/"><div class="card-body"> <span class="timeago small" > Sep 5, 2023 <i class="unloaded">2023-09-05T10:25:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>javax.net.ssl.SSLHandshakeException - No appropriate protocol (protocol is disabled or cipher suites are inappropriate)의 원인을 찾아서</h3><div class="text-muted small"><p> 상황 신규 이전한 서버에서 애플리케이션을 띄우는데 다음과 같은 에러를 마주하게됐다. 이전 서버에서와 달라진 점은 CentOS 7.4에서 7.9로 바뀐 것밖에 없는데 뭐가 문제일까 이해가 잘되지 않았다. 또한 로컬 환경에서는 문제없이 실행되는 상황이라 추적이 더 어려웠다. 1 2 3 4 5 6 Caused by: javax.net.ssl.SSL...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/mysql-round-up-part2/" class="btn btn-outline-primary" prompt="Older"><p>MySQL에서 시간,날짜 데이터를 저장할 때 반올림되는 현상 (2)</p></a> <a href="/posts/https-to-http-redirect/" class="btn btn-outline-primary" prompt="Newer"><p>HTTPS 요청이 HTTP로 리다이렉트 되는 현상</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/username">Lee JaeYoon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zz9z9.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
