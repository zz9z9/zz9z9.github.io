<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="MSA 환경에서 테스트하기(1) - 단위 테스트" /><meta property="og:locale" content="en_US" /><meta name="description" content="※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 9장을 읽고 필요한 부분을 정리한 내용입니다." /><meta property="og:description" content="※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 9장을 읽고 필요한 부분을 정리한 내용입니다." /><link rel="canonical" href="https://zz9z9.github.io/posts/msa-testing-part1/" /><meta property="og:url" content="https://zz9z9.github.io/posts/msa-testing-part1/" /><meta property="og:site_name" content="zz9z9" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-10T22:25:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="MSA 환경에서 테스트하기(1) - 단위 테스트" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2024-11-09T14:44:11+09:00","datePublished":"2021-07-10T22:25:00+09:00","description":"※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 9장을 읽고 필요한 부분을 정리한 내용입니다.","headline":"MSA 환경에서 테스트하기(1) - 단위 테스트","mainEntityOfPage":{"@type":"WebPage","@id":"https://zz9z9.github.io/posts/msa-testing-part1/"},"url":"https://zz9z9.github.io/posts/msa-testing-part1/"}</script><title>MSA 환경에서 테스트하기(1) - 단위 테스트 | zz9z9</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zz9z9"><meta name="application-name" content="zz9z9"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-Q7PWLG5WYT"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Q7PWLG5WYT'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Soccerball.svg/1000px-Soccerball.svg.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zz9z9</a></div><div class="site-subtitle font-italic">거창한 계획보다는, 꾸준한 실행을</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zz9z9" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>MSA 환경에서 테스트하기(1) - 단위 테스트</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>MSA 환경에서 테스트하기(1) - 단위 테스트</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Lee JaeYoon </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Sat, Jul 10, 2021, 10:25 PM +0900" prep="on" > Jul 10, 2021 <i class="unloaded">2021-07-10T22:25:00+09:00</i> </span></div><div> <span> <span class="timeago lastmod" data-toggle="tooltip" data-placement="bottom" title="Sat, Nov 9, 2024, 2:44 PM +0900" prefix="Updated " > Nov 9, 2024 <i class="unloaded">2024-11-09T14:44:11+09:00</i> </span> </span> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2133 words">11 min</span></div></div><div class="post-content"><p><em>※ 해당 내용은 ‘마이크로서비스 패턴(크리스 리처드슨)’ 9장을 읽고 필요한 부분을 정리한 내용입니다.</em></p><h1 id="테스트-개요">테스트 개요</h1><hr /><h2 id="자동화-테스트-작성">자동화 테스트 작성</h2><blockquote><p>설정 → 실행 → 확인 → 정리</p></blockquote><ol><li>설정 - SUT(System Under Test, 테스트할 대상)와 그 디펜던시로 구성된 테스트 픽스처(test fixture)를 초기화한다.<li>실행 - SUT 호출 (ex : 테스트 클래스의 특정 메서드)<li>확인 - 호출 결과 및 SUT의 상태를 단언(assertion)<li>정리 - 필요한 경우 설정 단계에서 초기화한 DB 트랜잭션을 롤백하는 등의 뒷정리</ol><h2 id="stubmock을-이용한-테스트">Stub/Mock을 이용한 테스트</h2><blockquote><p>SUT는 대부분 디펜던시를 갖고 있고, 이런 디펜던시 때문에 테스트가 복잡하고 느려질 수 있다. 예를 들어, OrderController 클래스는 OrderService를 호출하고, OrderService 역시 다른 수많은 애플리케이션/인프라 서비스에 의존할 수 있다. 이런 경우, OrderController만 따로 테스트하고 싶다면 ?</p></blockquote><ul><li>SUT가 의존하는 디펜던시를 테스트 더블(디펜던시의 동작을 흉내낸 객체)로 대체한다.<li>테스트 더블은 스텁, 목 두 종류가 있다.<ul><li>스텁(stub) - SUT에 값을 반환하는 객체<li>목(mock) - 스텁의 일종으로, SUT가 정확하게 디펜던시를 호출했는지 확인하는 객체</ul><li>일반적으로 테스트 더블은 목 객체 프레임워크인 <code class="language-plaintext highlighter-rouge">Mockito</code>를 활용해서 구현한다.</ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125169216-1e2d2400-e1e4-11eb-9368-8d0ad4a4b4ce.png" width="80%" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.296</figcaption></figure><h2 id="자동화-테스트의-종류">자동화 테스트의 종류</h2><ul><li>일반적으로 ‘범위’에 따라 테스트는 다음과 같이 나뉜다.<ul><li>단위 테스트(unit test) - 서비스의 작은 부분(ex : 클래스)을 테스트<li>통합 테스트(integration test) - 테스트 대상 서비스가 인프라 서비스, 타 서비스 등과 연동되어 잘 작동하는지 테스트<li>컴포넌트 테스트(component test) - 개별 서비스에 대한 인수 테스트(acceptance test)<li>종단 간 테스트(end-to-end test) - 전체 애플리케이션에 대한 인수 테스트</ul><li>종단 간 테스트는 중간에 있는 수 많은 디펜던시까지 실행시켜야 하기 때문에, 가능한 한 작성하지 않는 것이 최선이다.</ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125169087-99daa100-e1e3-11eb-82c5-6d718fb08204.png" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.299</figcaption></figure><h1 id="단위-테스트-작성">단위 테스트 작성</h1><hr /><blockquote><p>단위 테스트는 서비스의 아주 작은 부속품인 단위(unit)가 제대로 동작하는지 확인하는 테스트이다. 일반적으로 단위는 클래스이므로 단위 테스트의 목표는 해당 클래스가 잘 동작하는지 확인하는 것이다.</p></blockquote><ul><li>단위 테스트에는 두 가지 종류가 있다.<ul><li>독립(solitary) 단위 테스트 - 클래스 디펜던시를 목 객체로 나타내고 클래스를 따로 테스트<li>공동(sociable) 단위 테스트 - 클래스와 디펜던시를 테스트</ul><li>어떤 종류의 단위테스트를 할지는 클래스의 책임과 아키텍처에서의 역할마다 다르다. 다음은 일반적으로 많이 쓰는 테스트 전략이다.<ul><li>엔티티와 값 객체(Value Object) 같은 도메인 객체는 공동 단위 테스트 수행<li>여러 서비스에 걸쳐 데이터 일관성을 유지하는 사가는 공동 단위 테스트 수행<li>컨트롤러와 도메인 서비스 클래스는 독립 단위 테스트 수행<li>인바운드/아웃바운드 메시징 게이트웨이는 독립 단위 테스트 수행</ul></ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125170218-d8bf2580-e1e8-11eb-9135-7f220666368a.png" /><figcaption align="center">출처 : Chris Richardson, 『Microservice Patterns』, p.308</figcaption></figure><h2 id="도메인-서비스-테스트">도메인 서비스 테스트</h2><blockquote><p>이 클래스에 있는 메서드는 일반적으로 엔티티와 리파지토리를 호출하며 도메인 이벤트를 발행한다. 이런 종류의 클래스를 효과적으로 테스트 하려면, 리파지토리 및 메시징 클래스 같은 디펜던시를 모킹(mocking)하고 독립 단위 테스트를 수행해야 한다.</p></blockquote><ul><li>일반적으로 다음과 같은 프로세스로 진행된다.<ol><li>설정 : 서비스 디펜던시의 목 객체를 구성<li>실행 : 서비스 메서드를 호출<li>확인 : 서비스 메서드가 올바른 값을 반환하고 디펜던시가 올바르게 호출되었는지 확인</ol></ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderServiceTest</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">OrderService</span> <span class="n">orderService</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">OrderRepository</span> <span class="n">orderRepository</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">DomainEventPublisher</span> <span class="n">eventPublisher</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">RestaurantRepository</span> <span class="n">restaurantRepository</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">SagaManager</span><span class="o">&lt;</span><span class="nc">CreateOrderSagaState</span><span class="o">&gt;</span> <span class="n">createOrderSagaManager</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">SagaManager</span><span class="o">&lt;</span><span class="nc">CancelOrderSagaData</span><span class="o">&gt;</span> <span class="n">cancelOrderSagaManager</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">SagaManager</span><span class="o">&lt;</span><span class="nc">ReviseOrderSagData</span><span class="o">&gt;</span> <span class="n">reviseOrderSagaManager</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">OrderDomainEventPublisher</span> <span class="n">orderAggregateEventPublisher</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setup</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">orderRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">OrderRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">eventPublisher</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">DomainEventPublisher</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">restaurantRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">RestaurantRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">createOrderSagaManager</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">SagaManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">cancelOrderSagaManager</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">SagaManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">reviseOrderSagaManager</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">SagaManager</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="c1">// Mock DomainEventPublisher AND use the real OrderDomainEventPublisher</span>

    <span class="n">orderAggregateEventPublisher</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">OrderDomainEventPublisher</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>

    <span class="n">orderService</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderService</span><span class="o">(</span><span class="n">orderRepository</span><span class="o">,</span> <span class="n">eventPublisher</span><span class="o">,</span> <span class="n">restaurantRepository</span><span class="o">,</span>
            <span class="n">createOrderSagaManager</span><span class="o">,</span> <span class="n">cancelOrderSagaManager</span><span class="o">,</span> <span class="n">reviseOrderSagaManager</span><span class="o">,</span> <span class="n">orderAggregateEventPublisher</span><span class="o">,</span> <span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>
  <span class="o">}</span>


  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldCreateOrder</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">when</span><span class="o">(</span><span class="n">restaurantRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="no">AJANTA_ID</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="no">AJANTA_RESTAURANT</span><span class="o">));</span>
    <span class="n">when</span><span class="o">(</span><span class="n">orderRepository</span><span class="o">.</span><span class="na">save</span><span class="o">(</span><span class="n">any</span><span class="o">(</span><span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">))).</span><span class="na">then</span><span class="o">(</span><span class="n">invocation</span> <span class="o">-&gt;</span> <span class="o">{</span>
      <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="o">(</span><span class="nc">Order</span><span class="o">)</span> <span class="n">invocation</span><span class="o">.</span><span class="na">getArguments</span><span class="o">()[</span><span class="mi">0</span><span class="o">];</span>
      <span class="n">order</span><span class="o">.</span><span class="na">setId</span><span class="o">(</span><span class="no">ORDER_ID</span><span class="o">);</span>
      <span class="k">return</span> <span class="n">order</span><span class="o">;</span>
    <span class="o">});</span>

    <span class="nc">Order</span> <span class="n">order</span> <span class="o">=</span> <span class="n">orderService</span><span class="o">.</span><span class="na">createOrder</span><span class="o">(</span><span class="no">CONSUMER_ID</span><span class="o">,</span> <span class="no">AJANTA_ID</span><span class="o">,</span> <span class="no">CHICKEN_VINDALOO_MENU_ITEMS_AND_QUANTITIES</span><span class="o">);</span>

    <span class="n">verify</span><span class="o">(</span><span class="n">orderRepository</span><span class="o">).</span><span class="na">save</span><span class="o">(</span><span class="n">same</span><span class="o">(</span><span class="n">order</span><span class="o">));</span>

    <span class="n">verify</span><span class="o">(</span><span class="n">orderAggregateEventPublisher</span><span class="o">).</span><span class="na">publish</span><span class="o">(</span><span class="n">order</span><span class="o">,</span>
            <span class="nc">Collections</span><span class="o">.</span><span class="na">singletonList</span><span class="o">(</span><span class="k">new</span> <span class="nc">OrderCreatedEvent</span><span class="o">(</span><span class="no">CHICKEN_VINDALOO_ORDER_DETAILS</span><span class="o">,</span> <span class="nc">RestaurantMother</span><span class="o">.</span><span class="na">AJANTA_RESTAURANT_NAME</span><span class="o">)));</span>

    <span class="n">verify</span><span class="o">(</span><span class="n">createOrderSagaManager</span><span class="o">).</span><span class="na">create</span><span class="o">(</span><span class="k">new</span> <span class="nc">CreateOrderSagaState</span><span class="o">(</span><span class="no">ORDER_ID</span><span class="o">,</span> <span class="no">CHICKEN_VINDALOO_ORDER_DETAILS</span><span class="o">),</span> <span class="nc">Order</span><span class="o">.</span><span class="na">class</span><span class="o">,</span> <span class="no">ORDER_ID</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="c1">// TODO write tests for other methods</span>

<span class="o">}</span>
</pre></table></code></div></div><h2 id="컨트롤러-테스트">컨트롤러 테스트</h2><blockquote><p>컨트롤러 클래스는 각각 지정된 REST API 끝점을 담당한 여러 메서드로 구성된다. 메서드의 매개변수는 경로 변수(path variable)처럼 HTTP 요청에서 추출된 값을 나타낸다. 컨트롤러 메서드는 도메인 서비스 또는 리파지토리를 호출해서 응답 객체를 반환한다.</p></blockquote><ul><li>컨트롤러에서 호출하는 도메인 서비스, 리파지토리 같은 것들을 모킹하여 컨트롤러에 대해 독립 단위 테스트를 수행하는 것이 좋다.<li>컨트롤러 클래스를 인스턴스화하고 메서드를 호출할 수도 있지만, 이렇게 하면 요청 라우팅 같은 중요한 기능은 테스트할 수 없다.<li>따라서 목 MVC 테스트 프레임워크를 활용하는 것이 효율적이다.<ul><li><code class="language-plaintext highlighter-rouge">Spring MockMvc</code>, <code class="language-plaintext highlighter-rouge">Rest Assured Mock</code>이 대표적인 예이다.<li>HTTP 요청을 보내서 반환된 HTTP 응답을 단언(assertion)할 수 있기 때문에 진짜 네트워크 호출을 하지 않아도 HTTP 요청 라우팅 및 자바 객체 ⟷ JSON 변환이 가능하다.</ul></ul><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/125201570-b8579f80-e2aa-11eb-8832-e99d925a3497.png" /><figcaption align="center">출처 : https://terasolunaorg.github.io/guideline/5.4.1.RELEASE/en/UnitTest/ImplementsOfUnitTest</figcaption></figure><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderControllerTest</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">OrderService</span> <span class="n">orderService</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">OrderRepository</span> <span class="n">orderRepository</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">OrderController</span> <span class="n">orderController</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">orderService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">OrderService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">orderRepository</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">OrderRepository</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">orderController</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderController</span><span class="o">(</span><span class="n">orderService</span><span class="o">,</span> <span class="n">orderRepository</span><span class="o">);</span>
  <span class="o">}</span>


  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldFindOrder</span><span class="o">()</span> <span class="o">{</span>

    <span class="n">when</span><span class="o">(</span><span class="n">orderRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">of</span><span class="o">(</span><span class="no">CHICKEN_VINDALOO_ORDER</span><span class="o">));</span>

    <span class="n">given</span><span class="o">().</span>
            <span class="n">standaloneSetup</span><span class="o">(</span><span class="n">configureControllers</span><span class="o">(</span><span class="n">orderController</span><span class="o">)).</span>
    <span class="n">when</span><span class="o">().</span>
            <span class="n">get</span><span class="o">(</span><span class="s">"/orders/1"</span><span class="o">).</span>
    <span class="n">then</span><span class="o">().</span>
            <span class="n">statusCode</span><span class="o">(</span><span class="mi">200</span><span class="o">).</span>
            <span class="n">body</span><span class="o">(</span><span class="s">"orderId"</span><span class="o">,</span> <span class="n">equalTo</span><span class="o">(</span><span class="k">new</span> <span class="nc">Long</span><span class="o">(</span><span class="nc">OrderDetailsMother</span><span class="o">.</span><span class="na">ORDER_ID</span><span class="o">).</span><span class="na">intValue</span><span class="o">())).</span>
            <span class="n">body</span><span class="o">(</span><span class="s">"state"</span><span class="o">,</span> <span class="n">equalTo</span><span class="o">(</span><span class="nc">OrderDetailsMother</span><span class="o">.</span><span class="na">CHICKEN_VINDALOO_ORDER_STATE</span><span class="o">.</span><span class="na">name</span><span class="o">())).</span>
            <span class="n">body</span><span class="o">(</span><span class="s">"orderTotal"</span><span class="o">,</span> <span class="n">equalTo</span><span class="o">(</span><span class="no">CHICKEN_VINDALOO_ORDER_TOTAL</span><span class="o">.</span><span class="na">asString</span><span class="o">()))</span>
    <span class="o">;</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldFindNotOrder</span><span class="o">()</span> <span class="o">{</span>
    <span class="n">when</span><span class="o">(</span><span class="n">orderRepository</span><span class="o">.</span><span class="na">findById</span><span class="o">(</span><span class="mi">1L</span><span class="o">)).</span><span class="na">thenReturn</span><span class="o">(</span><span class="nc">Optional</span><span class="o">.</span><span class="na">empty</span><span class="o">());</span>

    <span class="n">given</span><span class="o">().</span>
            <span class="n">standaloneSetup</span><span class="o">(</span><span class="n">configureControllers</span><span class="o">(</span><span class="k">new</span> <span class="nc">OrderController</span><span class="o">(</span><span class="n">orderService</span><span class="o">,</span> <span class="n">orderRepository</span><span class="o">))).</span>
    <span class="n">when</span><span class="o">().</span>
            <span class="n">get</span><span class="o">(</span><span class="s">"/orders/1"</span><span class="o">).</span>
    <span class="n">then</span><span class="o">().</span>
            <span class="n">statusCode</span><span class="o">(</span><span class="mi">404</span><span class="o">)</span>
    <span class="o">;</span>
  <span class="o">}</span>

  <span class="kd">private</span> <span class="nc">StandaloneMockMvcBuilder</span> <span class="nf">configureControllers</span><span class="o">(</span><span class="nc">Object</span><span class="o">...</span> <span class="n">controllers</span><span class="o">)</span> <span class="o">{</span>
    <span class="nc">CommonJsonMapperInitializer</span><span class="o">.</span><span class="na">registerMoneyModule</span><span class="o">();</span>
    <span class="nc">MappingJackson2HttpMessageConverter</span> <span class="n">converter</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">MappingJackson2HttpMessageConverter</span><span class="o">(</span><span class="nc">JSonMapper</span><span class="o">.</span><span class="na">objectMapper</span><span class="o">);</span>
    <span class="k">return</span> <span class="nc">MockMvcBuilders</span><span class="o">.</span><span class="na">standaloneSetup</span><span class="o">(</span><span class="n">controllers</span><span class="o">).</span><span class="na">setMessageConverters</span><span class="o">(</span><span class="n">converter</span><span class="o">);</span>
  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h2 id="이벤트메세지-핸들러-테스트">이벤트/메세지 핸들러 테스트</h2><blockquote><p>메세지 어댑터는 컨트롤러처럼 도메인 서비스, 레파지토리 등을 호출하는 단순 클래스이다. 즉, 메세지 어댑터의 각 메서드는 메세지/이벤트에서 꺼낸 데이터를 서비스 메서드에 넘겨 호출한다. 따라서, 메세지 어댑터는 컨트롤러와 비슷한 방법으로 단위 테스트를 수행할 수 있다.</p></blockquote><ul><li>테스트별로 메세지 어탭터 인스턴스를 생성하고 메세지를 채널에 전송한 후, 서비스 목이 정확히 호출되었는지 확인한다.<li>메세징 인프라는 스터빙하기 때문에 실제 메세지 브로커는 관여하지 않는다.<li><code class="language-plaintext highlighter-rouge">Eventuate Tram Mock Messaging</code> 프레임워크를 이용해서 테스트한다.</ul><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">class</span> <span class="nc">OrderEventConsumerTest</span> <span class="o">{</span>

  <span class="kd">private</span> <span class="nc">OrderService</span> <span class="n">orderService</span><span class="o">;</span>
  <span class="kd">private</span> <span class="nc">OrderEventConsumer</span> <span class="n">orderEventConsumer</span><span class="o">;</span>

  <span class="nd">@Before</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">setUp</span><span class="o">()</span> <span class="kd">throws</span> <span class="nc">Exception</span> <span class="o">{</span>
    <span class="n">orderService</span> <span class="o">=</span> <span class="n">mock</span><span class="o">(</span><span class="nc">OrderService</span><span class="o">.</span><span class="na">class</span><span class="o">);</span>
    <span class="n">orderEventConsumer</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">OrderEventConsumer</span><span class="o">(</span><span class="n">orderService</span><span class="o">);</span>
  <span class="o">}</span>

  <span class="nd">@Test</span>
  <span class="kd">public</span> <span class="kt">void</span> <span class="nf">shouldCreateMenu</span><span class="o">()</span> <span class="o">{</span>

    <span class="nc">CommonJsonMapperInitializer</span><span class="o">.</span><span class="na">registerMoneyModule</span><span class="o">();</span>

    <span class="n">given</span><span class="o">().</span>
            <span class="n">eventHandlers</span><span class="o">(</span><span class="n">orderEventConsumer</span><span class="o">.</span><span class="na">domainEventHandlers</span><span class="o">()).</span>
    <span class="n">when</span><span class="o">().</span>
            <span class="n">aggregate</span><span class="o">(</span><span class="s">"net.chrisrichardson.ftgo.restaurantservice.domain.Restaurant"</span><span class="o">,</span> <span class="no">AJANTA_ID</span><span class="o">).</span>
            <span class="n">publishes</span><span class="o">(</span><span class="k">new</span> <span class="nc">RestaurantCreated</span><span class="o">(</span><span class="no">AJANTA_RESTAURANT_NAME</span><span class="o">,</span> <span class="nc">RestaurantMother</span><span class="o">.</span><span class="na">AJANTA_RESTAURANT_MENU</span><span class="o">)).</span>
    <span class="n">then</span><span class="o">().</span>
       <span class="n">verify</span><span class="o">(()</span> <span class="o">-&gt;</span> <span class="o">{</span>
         <span class="n">verify</span><span class="o">(</span><span class="n">orderService</span><span class="o">).</span><span class="na">createMenu</span><span class="o">(</span><span class="no">AJANTA_ID</span><span class="o">,</span> <span class="no">AJANTA_RESTAURANT_NAME</span><span class="o">,</span> <span class="k">new</span> <span class="nc">RestaurantMenu</span><span class="o">(</span><span class="nc">RestaurantMother</span><span class="o">.</span><span class="na">AJANTA_RESTAURANT_MENU_ITEMS</span><span class="o">));</span>
       <span class="o">})</span>
    <span class="o">;</span>

  <span class="o">}</span>

<span class="o">}</span>
</pre></table></code></div></div><h1 id="참고자료">참고자료</h1><hr /><ul><li>크리스 리처드슨, 『마이크로서비스 패턴』, 길벗(2020), 9장</ul></div><div class="post-tail-wrapper text-muted"><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=MSA 환경에서 테스트하기(1) - 단위 테스트 - zz9z9&url=https://zz9z9.github.io/posts/msa-testing-part1/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=MSA 환경에서 테스트하기(1) - 단위 테스트 - zz9z9&u=https://zz9z9.github.io/posts/msa-testing-part1/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=MSA 환경에서 테스트하기(1) - 단위 테스트 - zz9z9&url=https://zz9z9.github.io/posts/msa-testing-part1/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/jpa-entity-manager-persistence-context/">EntityManager와 영속성 컨텍스트</a><li><a href="/posts/jpa-id-generation-strategy/">JPA/Hibernate ID 생성 전략</a><li><a href="/posts/aws-vpc/">AWS VPC(Virtual Private Cloud) - 기초 개념</a><li><a href="/posts/aws-efs/">AWS EFS(Elastic File System) - 기초 개념</a><li><a href="/posts/aws-intro/">AWS - 상품 살펴보기</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/cautions-when-jpa-mybatis-together/"><div class="card-body"> <span class="timeago small" > Feb 10 <i class="unloaded">2026-02-10T22:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JPA / MyBatis 혼용시 주의사항 (in 배치 애플리케이션)</h3><div class="text-muted small"><p> JPA와 MyBatis는 서로의 존재를 모른다. MyBatis는 JDBC를 직접 사용하므로 JPA 영속성 컨텍스트를 우회하여 DB를 변경하고, JPA는 이를 감지할 수 없다. 결과적으로 JPA 1차 캐시에는 변경 전 데이터(stale data)가 남게 되어 데이터 불일치가 발생한다. 문제 상황 예시 1. 같은 엔티티를 JPA로 읽고 ...</p></div></div></a></div><div class="card"> <a href="/posts/how-jpa-item-writer-merge-works/"><div class="card-body"> <span class="timeago small" > Jan 29 <i class="unloaded">2026-01-29T23:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>이슈 - JpaItemWriter로 엔티티 저장시, ChunkSize만큼 SELECT 쿼리 발생하는 상황</h3><div class="text-muted small"><p> 상황 배치 애플리케이션에서 A 테이블에서 조회 -&gt; 가공 -&gt; B 테이블에 저장 흐름으로 동작하는 청크 기반의 Job이 있음 B 테이블에 저장시 JpaItemWriter 사용 B 테이블에 저장하는 엔티티의 PK는 A 테이블의 PK와 동일. 즉, A 테이블에서 조회한 엔티티의 PK가 사용됨 (Assigned ID + @Vers...</p></div></div></a></div><div class="card"> <a href="/posts/jpa-id-generation-strategy/"><div class="card-body"> <span class="timeago small" > Jan 29 <i class="unloaded">2026-01-29T23:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>JPA/Hibernate ID 생성 전략</h3><div class="text-muted small"><p> @GeneratedValue 기본 키(primary key) 값의 생성 전략을 지정하는 데 사용 즉, 데이터베이스에 새 레코드를 삽입할 때 기본 키 값을 자동으로 생성하는 방법을 지정 @GeneratedValue는 @Id와 함께 엔티티 또는 매핑된 슈퍼클래스의 기본 키 속성이나 필드에 적용할 수 있다. @GeneratedValu...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/jpa-entity-table-reserved-keyword/" class="btn btn-outline-primary" prompt="Older"><p>엔티티에서 데이터베이스 키워드/예약어 사용시 발생하는 문제</p></a> <a href="/posts/msa-testing-part2/" class="btn btn-outline-primary" prompt="Newer"><p>MSA 환경에서 테스트하기(2) - 통합 테스트</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/username">Lee JaeYoon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zz9z9.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
