<!DOCTYPE html><html lang="en-US" mode="light" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="generator" content="Jekyll v4.4.1" /><meta property="og:title" content="XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기" /><meta property="og:locale" content="en_US" /><meta name="description" content="상황 이 글 에서 언급했듯이, poi 라이브러리를 활용해서 엑셀을 만들 때, XSSF 클래스를 사용하면 데이터 건수(엑셀 row)가 많은 경우 OOM 에러가 발생한다. XSSF를 개선한 SXSSF를 사용하면 해당 문제를 해결할 수 있다고 하는데, 실제로 메모리 사용량을 비교해보고자 한다. 메모리 단면을 분석하는 방법은 이 글 을 참고한다." /><meta property="og:description" content="상황 이 글 에서 언급했듯이, poi 라이브러리를 활용해서 엑셀을 만들 때, XSSF 클래스를 사용하면 데이터 건수(엑셀 row)가 많은 경우 OOM 에러가 발생한다. XSSF를 개선한 SXSSF를 사용하면 해당 문제를 해결할 수 있다고 하는데, 실제로 메모리 사용량을 비교해보고자 한다. 메모리 단면을 분석하는 방법은 이 글 을 참고한다." /><link rel="canonical" href="https://zz9z9.github.io/posts/xssf-oom-analyze/" /><meta property="og:url" content="https://zz9z9.github.io/posts/xssf-oom-analyze/" /><meta property="og:site_name" content="zz9z9" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2021-07-23T23:00:00+09:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기" /><meta name="twitter:site" content="@twitter_username" /> <script type="application/ld+json"> {"@context":"https://schema.org","@type":"BlogPosting","dateModified":"2021-07-23T23:00:00+09:00","datePublished":"2021-07-23T23:00:00+09:00","description":"상황 이 글 에서 언급했듯이, poi 라이브러리를 활용해서 엑셀을 만들 때, XSSF 클래스를 사용하면 데이터 건수(엑셀 row)가 많은 경우 OOM 에러가 발생한다. XSSF를 개선한 SXSSF를 사용하면 해당 문제를 해결할 수 있다고 하는데, 실제로 메모리 사용량을 비교해보고자 한다. 메모리 단면을 분석하는 방법은 이 글 을 참고한다.","headline":"XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기","mainEntityOfPage":{"@type":"WebPage","@id":"https://zz9z9.github.io/posts/xssf-oom-analyze/"},"url":"https://zz9z9.github.io/posts/xssf-oom-analyze/"}</script><title>XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기 | zz9z9</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="zz9z9"><meta name="application-name" content="zz9z9"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script> <script defer src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.15.0,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id=G-Q7PWLG5WYT"></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', 'G-Q7PWLG5WYT'); }); </script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/d/d3/Soccerball.svg/1000px-Soccerball.svg.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">zz9z9</a></div><div class="site-subtitle font-italic">거창한 계획보다는, 꾸준한 실행을</div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tags ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center"> <a href="https://github.com/zz9z9" aria-label="github" target="_blank" rel="noopener"> <i class="fab fa-github-alt"></i> </a> <a href="https://twitter.com/twitter_username" aria-label="twitter" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['example','doamin.com'].join('@')" aria-label="email" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" > <i class="fas fa-rss"></i> </a></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Posts </a> </span> <span>XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Lee JaeYoon </span> <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Fri, Jul 23, 2021, 11:00 PM +0900" prep="on" > Jul 23, 2021 <i class="unloaded">2021-07-23T23:00:00+09:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="1633 words">9 min</span></div></div><div class="post-content"><h1 id="상황">상황</h1><hr /><ul><li><a href="https://zz9z9.github.io/posts/excel-using-poi-library/">이 글</a> 에서 언급했듯이, poi 라이브러리를 활용해서 엑셀을 만들 때, XSSF 클래스를 사용하면 데이터 건수(엑셀 row)가 많은 경우 OOM 에러가 발생한다.<li>XSSF를 개선한 SXSSF를 사용하면 해당 문제를 해결할 수 있다고 하는데, 실제로 메모리 사용량을 비교해보고자 한다.<ul><li>메모리 단면을 분석하는 방법은 <a href="https://zz9z9.github.io/posts/heap-analyze-with-jmap-and-mat/">이 글</a> 을 참고한다.</ul></ul><h1 id="분석하기">분석하기</h1><hr /><blockquote><p><code class="language-plaintext highlighter-rouge">jps</code> 명령어로 pid를 확인한 뒤, <code class="language-plaintext highlighter-rouge">jmap dump:&lt;dump-options&gt; &lt;pid&gt;</code>를 활용하여 덤프 파일을 생성하고 <br /> 해당 파일을 MAT(Eclipse Memory Analyzer)로 분석하였다.</p></blockquote><ul><li>테스트 환경<ul><li>CPU : 2.6 GHz 6코어 Intel Core i7<li>메모리 : 32GB 2667 MHz DDR4<li>java 8<li>메이븐 디펜던시 설정</ul></ul><div class="language-xml highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
</pre><td class="rouge-code"><pre><span class="cp">&lt;?xml version="1.0" encoding="UTF-8"?&gt;</span>
<span class="nt">&lt;project</span> <span class="na">xmlns=</span><span class="s">"http://maven.apache.org/POM/4.0.0"</span>
         <span class="na">xmlns:xsi=</span><span class="s">"http://www.w3.org/2001/XMLSchema-instance"</span>
         <span class="na">xsi:schemaLocation=</span><span class="s">"http://maven.apache.org/POM/4.0.0 http://maven.apache.org/xsd/maven-4.0.0.xsd"</span><span class="nt">&gt;</span>
    <span class="nt">&lt;modelVersion&gt;</span>4.0.0<span class="nt">&lt;/modelVersion&gt;</span>

    <span class="nt">&lt;properties&gt;</span>
        <span class="nt">&lt;maven.compiler.source&gt;</span>1.8<span class="nt">&lt;/maven.compiler.source&gt;</span>
        <span class="nt">&lt;maven.compiler.target&gt;</span>1.8<span class="nt">&lt;/maven.compiler.target&gt;</span>
    <span class="nt">&lt;/properties&gt;</span>

    <span class="nt">&lt;groupId&gt;</span>org.example<span class="nt">&lt;/groupId&gt;</span>
    <span class="nt">&lt;artifactId&gt;</span>performance-test<span class="nt">&lt;/artifactId&gt;</span>
    <span class="nt">&lt;version&gt;</span>1.0-SNAPSHOT<span class="nt">&lt;/version&gt;</span>

    <span class="nt">&lt;dependencies&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.maven.plugins<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>maven-compiler-plugin<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>3.8.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.poi<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>poi<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>4.0.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.poi<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>poi-ooxml<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>4.0.1<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
        <span class="nt">&lt;dependency&gt;</span>
            <span class="nt">&lt;groupId&gt;</span>org.apache.commons<span class="nt">&lt;/groupId&gt;</span>
            <span class="nt">&lt;artifactId&gt;</span>commons-compress<span class="nt">&lt;/artifactId&gt;</span>
            <span class="nt">&lt;version&gt;</span>1.19<span class="nt">&lt;/version&gt;</span>
        <span class="nt">&lt;/dependency&gt;</span>
    <span class="nt">&lt;/dependencies&gt;</span>

<span class="nt">&lt;/project&gt;</span>
</pre></table></code></div></div><h3 id="테스트-수행-클래스">테스트 수행 클래스</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.apache.poi.ss.usermodel.Cell</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.ss.usermodel.Row</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.ss.usermodel.Sheet</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.ss.usermodel.Workbook</span><span class="o">;</span>
<span class="kn">import</span> <span class="nn">org.apache.poi.ss.util.CellReference</span><span class="o">;</span>

<span class="kn">import</span> <span class="nn">java.io.FileOutputStream</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">PoiTester</span> <span class="o">{</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">ROW_CNT</span> <span class="o">=</span> <span class="mi">10000</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">COL_CNT</span> <span class="o">=</span> <span class="mi">10</span><span class="o">;</span>
    <span class="kd">private</span> <span class="kd">final</span> <span class="kt">long</span> <span class="no">THREAD_WAIT_TIME</span> <span class="o">=</span> <span class="mi">60000L</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">Workbook</span> <span class="n">workbook</span><span class="o">;</span>
    <span class="kd">private</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">;</span>

    <span class="kd">public</span> <span class="nf">PoiTester</span><span class="o">(</span><span class="nc">Workbook</span> <span class="n">workbook</span><span class="o">,</span> <span class="nc">String</span> <span class="n">fileName</span><span class="o">)</span> <span class="o">{</span>
        <span class="k">this</span><span class="o">.</span><span class="na">workbook</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">;</span>
        <span class="k">this</span><span class="o">.</span><span class="na">fileName</span> <span class="o">=</span> <span class="n">fileName</span><span class="o">;</span>
    <span class="o">}</span>

    <span class="kd">public</span> <span class="kt">void</span> <span class="nf">test</span><span class="o">()</span> <span class="o">{</span>
        <span class="kt">long</span> <span class="n">beginTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
        <span class="nc">Workbook</span> <span class="n">wb</span> <span class="o">=</span> <span class="n">workbook</span><span class="o">;</span>
        <span class="nc">Sheet</span> <span class="n">sh</span> <span class="o">=</span> <span class="n">wb</span><span class="o">.</span><span class="na">createSheet</span><span class="o">();</span>

        <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">rownum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">rownum</span> <span class="o">&lt;</span> <span class="no">ROW_CNT</span><span class="o">;</span> <span class="n">rownum</span><span class="o">++)</span> <span class="o">{</span>
            <span class="nc">Row</span> <span class="n">row</span> <span class="o">=</span> <span class="n">sh</span><span class="o">.</span><span class="na">createRow</span><span class="o">(</span><span class="n">rownum</span><span class="o">);</span>
            <span class="k">for</span> <span class="o">(</span><span class="kt">int</span> <span class="n">cellnum</span> <span class="o">=</span> <span class="mi">0</span><span class="o">;</span> <span class="n">cellnum</span> <span class="o">&lt;</span> <span class="no">COL_CNT</span><span class="o">;</span> <span class="n">cellnum</span><span class="o">++)</span> <span class="o">{</span>
                <span class="nc">Cell</span> <span class="n">cell</span> <span class="o">=</span> <span class="n">row</span><span class="o">.</span><span class="na">createCell</span><span class="o">(</span><span class="n">cellnum</span><span class="o">);</span>
                <span class="nc">String</span> <span class="n">address</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">CellReference</span><span class="o">(</span><span class="n">cell</span><span class="o">).</span><span class="na">formatAsString</span><span class="o">();</span>
                <span class="n">cell</span><span class="o">.</span><span class="na">setCellValue</span><span class="o">(</span><span class="n">address</span><span class="o">);</span>
            <span class="o">}</span>
        <span class="o">}</span>

        <span class="k">try</span> <span class="o">{</span>
            <span class="kt">long</span> <span class="n">endTime</span> <span class="o">=</span> <span class="nc">System</span><span class="o">.</span><span class="na">currentTimeMillis</span><span class="o">();</span>
            <span class="kt">long</span> <span class="n">totalTime</span> <span class="o">=</span> <span class="o">(</span> <span class="n">endTime</span> <span class="o">-</span> <span class="n">beginTime</span> <span class="o">)</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">;</span>

            <span class="nc">System</span><span class="o">.</span><span class="na">out</span><span class="o">.</span><span class="na">println</span><span class="o">(</span><span class="n">fileName</span><span class="o">+</span><span class="s">" 경과 시간 : "</span><span class="o">+</span><span class="n">totalTime</span><span class="o">+</span><span class="s">"초"</span><span class="o">);</span>

            <span class="nc">Thread</span><span class="o">.</span><span class="na">sleep</span><span class="o">(</span><span class="no">THREAD_WAIT_TIME</span><span class="o">);</span>

            <span class="nc">FileOutputStream</span> <span class="n">out</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">FileOutputStream</span><span class="o">(</span><span class="n">fileName</span><span class="o">+</span><span class="s">".xlsx"</span><span class="o">);</span>
            <span class="n">wb</span><span class="o">.</span><span class="na">write</span><span class="o">(</span><span class="n">out</span><span class="o">);</span>
            <span class="n">out</span><span class="o">.</span><span class="na">close</span><span class="o">();</span>
        <span class="o">}</span> <span class="k">catch</span> <span class="o">(</span><span class="nc">Exception</span> <span class="n">e</span><span class="o">)</span> <span class="o">{</span>
            <span class="n">e</span><span class="o">.</span><span class="na">printStackTrace</span><span class="o">();</span>
        <span class="o">}</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><h2 id="테스트-케이스1-xssf">테스트 케이스1. XSSF</h2><hr /><h3 id="테스트-코드">테스트 코드</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.apache.poi.xssf.usermodel.XSSFWorkbook</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">XssfTest</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">XSSFWorkbook</span> <span class="n">workbook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">XSSFWorkbook</span><span class="o">();</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="s">"xssf_ver"</span><span class="o">;</span>
        <span class="nc">PoiTester</span> <span class="n">tester</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PoiTester</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>

        <span class="n">tester</span><span class="o">.</span><span class="na">test</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>실행 결과 : <code class="language-plaintext highlighter-rouge">xssf_ver 경과 시간 : 1초</code></ul><h3 id="histogram">Histogram</h3><ul><li>히스토그램을 살펴보면 ElementXobj 클래스 XSSFSheet 클래스에서 메모리의 대부분을 차지하고 있음을 알 수 있다.<li>XSSFSheet 하나가 차지하는 메모리 크는 80byte 이지만, 해당 객체가 점유하고 있는 객체들을 모두 합치면 약 70Mb 정도를 차지하고 있는 것을 알 수 있다.<li>또한, 아래쪽에 보면 XSSFRow 즉, 행이 10000개 만들어진 것도 확인할 수 있다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/126831964-c998774b-2df9-4906-b571-d829a54a608c.png" alt="image" /></ul><h3 id="dominator-tree">Dominator Tree</h3><ul><li>Dominator Tree를 살펴보면 ElementXobj 객체로 인해 대부분의 메모리가 점유되고 있다.<li><code class="language-plaintext highlighter-rouge">.xlsx</code> 파일은 XML 기반이라고 하는데, XSSF는 이 XML을 처리하는데 메모리를 상당히 많이 차지하는 것 같다.<ul><li><code class="language-plaintext highlighter-rouge">.xlsx</code> 의 XML과 관련된 글은 <a href="https://d2.naver.com/helloworld/9423440">네이버 기술블로그의 다음 글</a> 을 참고해보면 좋을 것 같다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/126833565-449cc779-cb63-4b37-ab8c-ebb9bb330892.png" alt="image" /></ul></ul><h2 id="테스트-케이스2-sxssfauto-flush-사용하지-않음">테스트 케이스2. SXSSF(auto-flush 사용하지 않음)</h2><hr /><h3 id="테스트-코드-1">테스트 코드</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.apache.poi.xssf.streaming.SXSSFWorkbook</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SxssfNoAutoFlush</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SXSSFWorkbook</span> <span class="n">workbook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SXSSFWorkbook</span><span class="o">(-</span><span class="mi">1</span><span class="o">);</span> <span class="c1">// -1 : not use auto-flush</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="s">"sxssf_no_autoflush_ver"</span><span class="o">;</span>
        <span class="nc">PoiTester</span> <span class="n">tester</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PoiTester</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>

        <span class="n">tester</span><span class="o">.</span><span class="na">test</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>실행 결과 : <code class="language-plaintext highlighter-rouge">sxssf_no_autoflush_ver 경과 시간 : 10초</code></ul><h3 id="histogram-1">Histogram</h3><ul><li>히스토그램을 살펴보면 XSSFSheet에 비해 SXSSFSheet 객체 자체가 점유하는 메모리가 작고, 모든 객체가 점유하는 메모리를 합쳐도 15Mb 정도로 이전 70Mb에 비해 약 5배 줄어든 것을 확인할 수 있다.<li>또한, 아래쪽에 보면 SXSSFRow 즉, 행이 10000개 만들어진 것도 확인할 수 있다.<ul><li>10000개의 행이 모두 메모리 상에 있는 것을 통해 auto-flush가 적용되지 않은 것을 확인할 수 있다.<li>XSSFRow가 10000개 였을 때 0.24Mb를 차지했는데, SXSSFRow는 0.4Mb를 차지하는 것을 볼 수 있다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/126835008-f8ebd717-e2d3-4817-bed5-3cf69bd6d1ba.png" alt="image" /></ul></ul><h3 id="dominator-tree-1">Dominator Tree</h3><ul><li>XSSF를 사용할 때와는 다르게 ElementXobj 객체로 인한 낭비는 보이지 않는 것 같다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/126836904-3fbee4e0-2d99-4e84-abb7-6842fd653db3.png" alt="image" /></ul><h2 id="테스트-케이스3-sxssfauto-flush-사용">테스트 케이스3. SXSSF(auto-flush 사용)</h2><hr /><h3 id="테스트-코드-2">테스트 코드</h3><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kn">import</span> <span class="nn">org.apache.poi.xssf.streaming.SXSSFWorkbook</span><span class="o">;</span>

<span class="kd">public</span> <span class="kd">class</span> <span class="nc">SxssfAutoFlush</span> <span class="o">{</span>
    <span class="kd">public</span> <span class="kd">static</span> <span class="kt">void</span> <span class="nf">main</span><span class="o">(</span><span class="nc">String</span><span class="o">[]</span> <span class="n">args</span><span class="o">)</span> <span class="o">{</span>
        <span class="nc">SXSSFWorkbook</span> <span class="n">workbook</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">SXSSFWorkbook</span><span class="o">(</span><span class="mi">1000</span><span class="o">);</span> <span class="c1">// keep 1000 rows in memory, exceeding rows will be flushed to disk</span>
        <span class="nc">String</span> <span class="n">fileName</span> <span class="o">=</span> <span class="s">"sxssf_autoflush_ver"</span><span class="o">;</span>
        <span class="nc">PoiTester</span> <span class="n">tester</span> <span class="o">=</span> <span class="k">new</span> <span class="nc">PoiTester</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span> <span class="n">fileName</span><span class="o">);</span>

        <span class="n">tester</span><span class="o">.</span><span class="na">test</span><span class="o">();</span>
    <span class="o">}</span>
<span class="o">}</span>
</pre></table></code></div></div><ul><li>실행 결과 : <code class="language-plaintext highlighter-rouge">sxssf_autoflush_ver 경과 시간 : 2초</code></ul><h4 id="참고-sxssfworkbook의-기본-윈도우-사이즈는-100이다">참고. SXSSFWorkbook의 기본 윈도우 사이즈는 100이다.</h4><div class="language-java highlighter-rouge"><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">public</span> <span class="kd">static</span> <span class="kd">final</span> <span class="kt">int</span> <span class="no">DEFAULT_WINDOW_SIZE</span> <span class="o">=</span> <span class="mi">100</span><span class="o">;</span>

<span class="kd">public</span> <span class="nf">SXSSFWorkbook</span><span class="o">()</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">((</span><span class="nc">XSSFWorkbook</span><span class="o">)</span><span class="kc">null</span><span class="o">);</span>
<span class="o">}</span>

<span class="kd">public</span> <span class="nf">SXSSFWorkbook</span><span class="o">(</span><span class="nc">XSSFWorkbook</span> <span class="n">workbook</span><span class="o">)</span> <span class="o">{</span>
    <span class="k">this</span><span class="o">(</span><span class="n">workbook</span><span class="o">,</span> <span class="mi">100</span><span class="o">);</span>
<span class="o">}</span>
</pre></table></code></div></div><h3 id="histogram-2">Histogram</h3><ul><li>SXSSFSheet 객체와 그 안에 모든 객체가 점유하는 메모리를 합쳐도 1.6Mb 정도이다.<ul><li>XSSF에 비해 약 50배, auto-flush를 사용하지 않을 때에 비해 약 10배의 메모리를 덜 점유한다.</ul><li>또한, 아래쪽에 보면 SXSSFRow 즉, 행이 1000개만 있는 것을 볼 수 있다.<ul><li>지정한 row access window size(위 코드에서는 1000) 이상이 메모리에 적재되면 디스크로 flush하는 auto-flush 기능이 잘 작동하는 것을 알 수 있다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/126835149-ad4776e1-1b70-41ac-87c0-236238d7804a.png" alt="image" /></ul></ul><h3 id="dominator-tree-2">Dominator Tree</h3><ul><li>메모리 낭비가 없다고 봐도 무방할 것 같다. <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/126835214-bf45207f-7866-4caa-a683-3523f767622e.png" alt="image" /></ul><h1 id="회사-코드에-적용하기">회사 코드에 적용하기</h1><hr /><blockquote><p>이제 회사 코드에 적용해보고 얼만큼의 효과가 있을지 확인해보자. 데이터 건수는 약 5600건 이다. <br /> (보안망으로 인해 테스트 결과는 핸드폰 카메라로 찍었습니다. 화질이 좋지 않으점 양해 부탁드립니다.)</p></blockquote><h2 id="before-xssf-사용">Before (XSSF 사용)</h2><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/130100579-bebebec9-d636-4c75-a141-e45409a641f4.png" /><figcaption align="center">메모리 약 300Mb 차지</figcaption></figure><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/130100976-454ef7f9-4add-4326-b4f4-c65760894403.png" /><figcaption align="center">엑셀 파일 생성전까지 모든 row를 메모리에 저장</figcaption></figure><h2 id="after-sxssf-사용---default-window-size">After (SXSSF 사용 - default window size)</h2><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/130101241-36c1ee77-4c6b-4895-92ff-f0a63cc93ddf.png" /><figcaption align="center">메모리 약 8Mb 차지</figcaption></figure><figure align="center"> <img src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" data-src="https://user-images.githubusercontent.com/64415489/130101870-cb6a92f1-ed4f-4789-bbf4-d919a95db84d.png" /><figcaption align="center">window size 만큼(default : 100) 메모리에 저장</figcaption></figure><h1 id="결론">결론</h1><hr /><ul><li>추측 : XSSF는 XML 기반의 무언가를 처리함에 있어서 메모리 낭비가 심하다.<li>XSSF는 엑셀 파일 생성 전까지 모든 행을 메모리에 올려두기 때문에, 데이터가 많은 경우 OOM이 발생할 수 있다.<li>poi를 활용해 엑셀을 만든다면 SXSSF를 auto-flush 기능을 활성화해서 사용하자.(특별한 이유가 없다면 default size를 사용하면 될 것 같다.)</ul></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/%EA%B2%BD%ED%97%98%ED%95%98%EA%B8%B0/'>경험하기</a>, <a href='/categories/%EC%9D%B4%EC%8A%88-%EB%85%B8%ED%8A%B8/'>이슈 노트</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/java/" class="post-tag no-text-decoration" >Java</a> <a href="/tags/heap-memory/" class="post-tag no-text-decoration" >Heap Memory</a> <a href="/tags/eclipse-memory-analyzer/" class="post-tag no-text-decoration" >Eclipse Memory Analyzer</a> <a href="/tags/apache-poi/" class="post-tag no-text-decoration" >apache poi</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/">CC BY 4.0</a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기 - zz9z9&url=https://zz9z9.github.io/posts/xssf-oom-analyze/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기 - zz9z9&u=https://zz9z9.github.io/posts/xssf-oom-analyze/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=XSSF로 인한 OOM 에러 그리고 SXSSF와 메모리 사용량 비교해보기 - zz9z9&url=https://zz9z9.github.io/posts/xssf-oom-analyze/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i class="fa-fw fas fa-link small" onclick="copyLink()" data-toggle="tooltip" data-placement="top" title="Copy link"></i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/jpa-entity-manager-persistence-context/">EntityManager와 영속성 컨텍스트</a><li><a href="/posts/jpa-id-generation-strategy/">JPA/Hibernate ID 생성 전략</a><li><a href="/posts/aws-vpc/">AWS VPC(Virtual Private Cloud) - 기초 개념</a><li><a href="/posts/aws-efs/">AWS EFS(Elastic File System) - 기초 개념</a><li><a href="/posts/aws-intro/">AWS - 상품 살펴보기</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/try-with-resource-caution/"><div class="card-body"> <span class="timeago small" > Sep 5, 2021 <i class="unloaded">2021-09-05T14:00:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>try-with-resource 사용시 Socket closed 예외 발생</h3><div class="text-muted small"><p> 상황 자바로 만든 간단한 웹 서버에서 404, 500과 같은 에러 페이지 처리를 위해 catch 절 내부에 에러 페이지를 응답하는 로직을 작성했다. 하지만 에러 발생시 에러 페이지가 응답되지 않고 java.net.SocketException: Socket closed가 발생했다. 1 2 3 4 5 6 7 8 9 10 11 12 13 14 publi...</p></div></div></a></div><div class="card"> <a href="/posts/sxssf-memory-flush/"><div class="card-body"> <span class="timeago small" > Jul 12, 2025 <i class="unloaded">2025-07-12T22:25:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>SXSSF를 사용하는데 OOM이 발생한다 ?</h3><div class="text-muted small"><p> 상황 백오피스 시스템에서 조회 기간 길게해서 엑셀 파일 다운로드했더니 OOM 발생 해당 엑셀 다운로드 로직에서는 파일 생성을 위해 poi 라이브러리의 SXSSF 구현체 사용중 전에 XSSF 구현체와 비교했을때, SXSSF는 row를 메모리에서 디스크로 flush 하면서 생성한다고 했는데 왜 OOM이 발생한걸까 ? (SXSSFRo...</p></div></div></a></div><div class="card"> <a href="/posts/java-io-nio/"><div class="card-body"> <span class="timeago small" > Sep 7, 2021 <i class="unloaded">2021-09-07T00:29:00+09:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Java - 자바 IO, NIO</h3><div class="text-muted small"><p> Java I/O Input, Output을 나타낸다. In, Out의 기준은 JVM이다. 즉, JVM으로 들어오는 데이터를 다루는 경우엔 Input 데이터를 내보내는 경우엔 Output이다. Stream 기반이다. 한 번에 1byte 또는 그 이상의 byte를 읽는다. 데이터가 캐시되지 않는다. 따라서 데...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/excel-using-poi-library/" class="btn btn-outline-primary" prompt="Older"><p>Java - 자바로 엑셀을 만들기 위한 POI 라이브러리 살펴보기</p></a> <a href="/posts/kafka-delivery-guarantees-exactly-once/" class="btn btn-outline-primary" prompt="Newer"><p>카프카 전달보증 구현하기 - Exactly Once</p></a></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2026 <a href="https://twitter.com/username">Lee JaeYoon</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author.">Some rights reserved.</span></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a> with <a href="https://github.com/cotes2020/jekyll-theme-chirpy" target="_blank" rel="noopener">Chirpy</a> theme.</p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/java/">Java</a> <a class="post-tag" href="/tags/mysql/">MySQL</a> <a class="post-tag" href="/tags/aws/">AWS</a> <a class="post-tag" href="/tags/spring/">Spring</a> <a class="post-tag" href="/tags/web/">WEB</a> <a class="post-tag" href="/tags/infra/">Infra</a> <a class="post-tag" href="/tags/jpa/">JPA</a> <a class="post-tag" href="/tags/hibernate/">Hibernate</a> <a class="post-tag" href="/tags/http/">HTTP</a> <a class="post-tag" href="/tags/spring-batch/">Spring Batch</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.7.3/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="https://zz9z9.github.io{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script>
